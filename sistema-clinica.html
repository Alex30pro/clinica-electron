<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gerenciamento de Clínica</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
        background: transparent;
        background-size: cover;
    }

        body {
            font-family: 'Inter', sans-serif;
            background: transparent;
            height: 100vh;
            overflow-y: hidden;
            color: #eee;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 280px;
            background: rgba(45, 50, 70, 0.9);
            backdrop-filter: blur(25px);
            border-right: 1px solid rgba(255, 255, 255, 0.15);
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        .logo {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .logo h1 {
            color: #eee;
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .logo p {
            color: #ccc;
            font-size: 14px;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            margin-bottom: 10px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            color: #ccc;
            text-decoration: none;
            border-radius: 10px;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .nav-link:hover,
        .nav-link.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .nav-link i {
            margin-right: 12px;
            font-size: 18px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 0; /* Remove padding para a titlebar */
            overflow-y: hidden;
            height: 100vh;
            display: flex; /* Para a titlebar funcionar */
            flex-direction: column;
        }

        .header {
            background: rgba(45, 50, 70, 0.8);
            backdrop-filter: blur(20px);
            border-radius: 15px;
            padding: 25px;
            margin: 20px; /* Adiciona margem de volta */
            margin-top: 0; /* Tira margem do topo */
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            flex-shrink: 0
        }

        .header h2 {
            color: #eee;
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .header p {
            color: #ccc;
            font-size: 16px;
        }

        /* Dashboard */
        .dashboard { 
            display: none; 
            margin: 20px; /* Adiciona a margem que .content-section tinha */
            margin-top: 0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(45, 50, 70, 0.8);
            backdrop-filter: blur(20px);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-card:hover { transform: translateY(-5px); }
        .stat-card i { font-size: 40px; color: #667eea; margin-bottom: 15px; }
        .stat-card h3 { font-size: 32px; font-weight: 700; color: #eee; margin-bottom: 5px; }
        .stat-card p { color: #ccc; font-size: 14px; }

        /* Content Sections */
        .content-section {
            display: none; 
            background: rgba(45, 50, 70, 0.8);
            backdrop-filter: blur(25px); 
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin: 20px; 
            margin-top: 0; 
        }

        .card {
            background: rgba(45, 50, 70, 0.8);
            backdrop-filter: blur(25px); 
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .content-wrapper {
            background: rgba(0, 0, 0, 0.5);
            padding: 20px;
            padding-top: 0;
            overflow-y: hidden;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .content-section.active, .dashboard.active {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            min-height: 0;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.8);
            flex-shrink: 0;
        }

        .section-header h3 { color: #eee; font-size: 24px; font-weight: 600; }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white; border: none; padding: 12px 24px;
            border-radius: 8px; cursor: pointer; font-weight: 500;
            transition: all 0.3s ease; font-size: 14px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn i {
            margin-right: 8px;
        }

        /* Forms */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px; margin-bottom: 20px;
        }
        .form-group { margin-bottom: 20px; }
        .form-group label {
            display: block; margin-bottom: 8px;
            font-weight: 500; color: #ccc;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%; padding: 12px 16px;
            border: 2px solid rgba(255,255,255, 0.1);
            background: rgba(0,0,0, 0.2);
            color: #eee;
            border-radius: 8px; font-size: 14px;
            transition: border-color 0.3s ease;
        }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        option {
            background: #333;
        }

        /* Tables */
        .table-container {
            overflow-x: auto; 
            overflow-y: auto;
            flex-grow: 1;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255, 0.1);
            min-height: 0;
        }
        table {
            width: 100%; border-collapse: collapse;
            background: transparent;
        }
        th, td {
            padding: 15px; text-align: left;
            border-bottom: 1px solid rgba(255,255,255, 0.2);
            color: #eee;
        }
        th {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255, 0.2);
            background: rgba(35, 40, 60, 0.9);
            font-weight: 600;
            color: #fff;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        tr:hover { background: rgba(255,255,255, 0.05); }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 6px;
        }

        .btn-edit {
            background: #28a745;
        }

        .btn-delete {
            background: #dc3545;
        }

        /* Calendar */
        .calendar {
            background: transparent;
            border-radius: 0;
            padding: 0;
            box-shadow: none;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: none;
            margin-bottom: 10px;
            padding-bottom: 10px;
            color: #ccc;
            font-weight: 500;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            overflow: hidden;
        }

        .calendar-day {
            background: rgba(0, 0, 0, 0.15);
            color: #eee;
            font-weight: 500;
            padding: 15px 10px;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.3s ease;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .calendar-day:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .calendar-day.today {
            background: #667eea;
            color: white;
        }

        .calendar-day.has-appointment {
            background: rgba(40, 167, 69, 0.4);
            border-left: none;
            color: #fff;
        }

        .appointment-dot {
            width: 8px;
            height: 8px;
            background: #fff;
            border-radius: 50%;
            margin: 2px auto;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: rgba(45, 50, 70, 0.9);
            backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #eee;
            margin: 5% auto; padding: 30px; border-radius: 15px;
            width: 90%; max-width: 600px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
            max-height: 90vh; overflow-y: auto; 
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .close {
            font-size: 28px;
            font-weight: bold;
            color: #ccc;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close:hover {
            color: #fff;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                padding: 15px;
            }

            .main-content {
                padding: 20px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeInUp 0.6s ease;
        }

        /* Estilo para o novo link de "ver paciente" */
        .link-paciente {
            color: #007bff; /* Um azul padrão de link */
            text-decoration: none;
            font-weight: 500;
            cursor: pointer;
        }
        .link-paciente:hover {
            text-decoration: underline;
        }
        /* --- Estilo para o Modal de Zoom --- */
        .modal-zoom {
            display: none;
            position: fixed;
            z-index: 2000; /* Mais alto que o outro modal */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8); /* Fundo mais escuro */
            backdrop-filter: blur(5px);
            justify-content: center;
            align-items: center;
        }
        .modal-zoom-content {
            max-width: 90%;
            max-height: 90%;
            animation: modalSlideIn 0.3s ease;
        }
        .modal-zoom-content img {
            width: 100%;
            height: 100%;
            object-fit: contain; /* Garante que a imagem caiba */
        }
        /* ======================================= */
        /* INÍCIO: NOVOS ESTILOS DA BARRA DE TÍTULO */
        /* ======================================= */
        .titlebar {
            width: 100%;
            height: 40px; /* Altura da barra */
            display: flex;
            flex-shrink: 0; /* Impede que encolha */
            background: rgba(35, 40, 60, 0.6);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .drag-region {
            flex-grow: 1; /* Ocupa todo o espaço para arrastar */
            /* Esta é a mágica do Electron: */
            -webkit-app-region: drag; 
        }
        .window-controls {
            display: flex;
            -webkit-app-region: no-drag; /* Botões NÃO são arrastáveis */
        }
        .window-control-btn {
            width: 45px;
            height: 100%;
            border: none;
            background: transparent;
            color: #ccc;
            font-size: 14px;
            transition: background 0.2s ease;
        }
        .window-control-btn i {
            font-size: 12px; /* Ajusta tamanho dos ícones */
        }
        .window-control-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }
        .window-control-btn.btn-close:hover {
            background: #e81123; /* Vermelho ao passar o mouse */
            color: #fff;
        }
        .search-bar-container {
            display: flex;
            align-items: center;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 8px 12px;
            flex-grow: 1; /* Faz ela ocupar o espaço disponível */
            margin: 0 20px; /* Espaço entre o título e o botão */
        }

        .search-bar-container i {
            color: #ccc;
            margin-right: 10px;
        }

        .search-bar-container input {
            width: 100%;
            border: none;
            background: transparent;
            color: #eee;
            font-size: 14px;
        }
        .search-bar-container input:focus {
            outline: none;
        }
        .search-bar-container input::placeholder {
            color: #999;
        }
    </style>
<base target="_blank">
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo">
                <h1><i class="fas fa-heartbeat"></i> RZB</h1>
                <p>Odontologia Especializada</p>
            </div>
            
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="#" class="nav-link active" data-section="dashboard">
                        <i class="fas fa-tachometer-alt"></i>
                        Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-section="pacientes">
                        <i class="fas fa-users"></i>
                        Pacientes
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-section="consultas">
                        <i class="fas fa-calendar-alt"></i>
                        Consultas
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-section="agenda">
                        <i class="fas fa-calendar-check"></i>
                        Agenda
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-section="relatorios">
                        <i class="fas fa-chart-bar"></i>
                        Relatórios
                    </a>
                </li>
                <li class="nav-item">
                <a href="#" class="nav-link" data-section="financeiro">
                    <i class="fas fa-dollar-sign"></i> Financeiro
                </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-section="estoque">
                        <i class="fas fa-boxes"></i> Estoque
                    </a>
                </li>
            </ul>
        </div>

       <div class="main-content">

            <div class="titlebar">
                <div class="drag-region"></div>
                <div class="window-controls">
                    <button class="window-control-btn" id="btn-minimize">
                        <i class="fas fa-window-minimize"></i>
                    </button>
                    <button class="window-control-btn" id="btn-maximize">
                        <i class="fas fa-window-maximize"></i>
                    </button>
                    <button class="window-control-btn btn-close" id="btn-close">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>

            <div class="content-wrapper">
            
                <div class="header">
                    <h2 id="page-title">Dashboard</h2>
                    <p id="page-subtitle">Visão geral da clínica</p>
                </div>

            <!-- Dashboard -->
            <div id="dashboard" class="dashboard active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <i class="fas fa-users"></i>
                        <h3 id="total-pacientes">0</h3>
                        <p>Total de Pacientes</p>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-calendar-check"></i>
                        <h3 id="consultas-hoje">0</h3>
                        <p>Consultas Hoje</p>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-clock"></i>
                        <h3 id="consultas-pendentes">0</h3>
                        <p>Consultas Pendentes</p>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-chart-line"></i>
                        <h3 id="total-consultas">0</h3>
                        <p>Total de Consultas</p>
                    </div>
                </div>

                <div class="content-section active">
                    <h3 style="margin-bottom: 20px; color: #333;">Próximas Consultas</h3>
                    <div class="table-container">
                        <table id="proximas-consultas">
                            <thead>
                                <tr>
                                    <th>Paciente</th>
                                    <th>Data</th>
                                    <th>Hora</th>
                                    <th>Tipo</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="proximas-consultas-tbody">
                                <tr>
                                    <td colspan="5" style="text-align: center; color: #999;">
                                        Nenhuma consulta agendada
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Pacientes Section -->
            <div id="pacientes" class="content-section">
                <div class="section-header">
                    <h3>Gerenciamento de Pacientes</h3>
                        <div class="search-bar-container">
                            <i class="fas fa-search"></i>
                            <input type="text" id="search-paciente-input" placeholder="Buscar paciente por nome...">
                        </div>
                    <button class="btn" onclick="sistema.abrirModalPaciente()">
                        <i class="fas fa-plus"></i> Novo Paciente
                    </button>
                </div> <p id="pacientes-lista-status" style="text-align: center; margin-bottom: 15px; color: #ccc; font-style: italic;"></p>

                <div class="table-container">
                    <table id="tabela-pacientes">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Telefone</th>
                                <th>Email</th>
                                <th>Data Nasc.</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="pacientes-tbody">
                            <tr>
                                <td colspan="6" style="text-align: center; color: #999;">
                                    Nenhum paciente cadastrado
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Consultas Section -->
            <div id="consultas" class="content-section">
                <div class="section-header">
                    <h3>Registro de Consultas</h3>
                    <div>
                        <button class="btn" onclick="sistema.abrirModalConsulta()">
                            <i class="fas fa-plus"></i> Nova Consulta
                        </button>
                    </div>
                </div>

                <div class="table-container">
                    
                    <table class="data-table"> 
                        <thead>
                            <tr>
                                <th>Paciente</th>
                                <th>Data</th>
                                <th>Hora</th>
                                <th>Tipo</th>
                                <th>Status</th>
                                <th>Observações</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="consultas-tbody">
                            <tr>
                                <td colspan="7" style="text-align: center; color: #ccc;">Nenhuma consulta registrada</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Agenda Section -->
            <div id="agenda" class="content-section">
                <div class="section-header">
                    <h3>Agenda de Consultas</h3>
                    <div>
                        <button class="btn" onclick="mesAnterior()">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <span id="mes-ano" style="margin: 0 20px; font-weight: 600;"></span>
                        <button class="btn" onclick="mesPosterior()">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>

                <div class="calendar">
                    <div class="calendar-header">
                        <div style="display: grid; grid-template-columns: repeat(7, 1fr); width: 100%; text-align: center; font-weight: 600; color: #666;">
                            <div>Dom</div>
                            <div>Seg</div>
                            <div>Ter</div>
                            <div>Qua</div>
                            <div>Qui</div>
                            <div>Sex</div>
                            <div>Sáb</div>
                        </div>
                    </div>
                    <div class="calendar-grid" id="calendar-grid">
                        <!-- Calendar days will be generated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Relatórios Section -->
            <div id="relatorios" class="content-section">
                <div class="section-header">
                    <h3>Relatórios e Estatísticas</h3>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label>Período</label>
                        
                        <select id="report-periodo">
                            <option value="hoje">Hoje</option>
                            <option value="semana">Esta Semana</option>
                            <option value="mes">Este Mês</option>
                            <option value="mes_passado">Mês Passado</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Tipo de Relatório</label>
                        
                        <select id="report-tipo">
                            <option value="consultas">Consultas</option>
                            <option value="pacientes">Pacientes</option>
                            <option value="financeiro">Financeiro</option>
                        </select>
                    </div>
                </div>

                <button class="btn" onclick="sistema.gerarRelatorio()">
                    <i class="fas fa-file-pdf"></i> Gerar Relatório
                </button>

                <div id="report-results-area" style="margin-top: 30px;">
                    <p>Selecione um período e tipo de relatório e clique em "Gerar Relatório".</p>
                </div>

                <div id="relatorio-content" style="margin-top: 30px;">
                    <p style="color: #999; text-align: center;">
                        Selecione as opções acima e clique em "Gerar Relatório"
                    </p>
        </div>
                <div class="card" style="margin-top: 30px; border-color: #ffc107;">
                <h5 style="color: #ffc107;">Backup e Exportação de Dados</h5>
                <p style="margin-top: 10px; margin-bottom: 20px; color: #ccc;">
                    Exporte todos os dados do sistema (Pacientes, Consultas, Financeiro e Estoque) como arquivos CSV.
                    Guarde este backup em um local seguro (pen drive ou nuvem).
                </p>
                <button class="btn" id="btn-exportar-backup" style="background: #ffc107; color: #333;">
                    <i class="fas fa-file-export"></i> Exportar Backup Completo
                </button>
                <p id="export-status-message" style="margin-top: 15px; color: #fff;"></p>
            </div>
    </div>

    <div id="financeiro" class="content-section">
        <div class="section-header">
            <h3>Gerenciamento Financeiro</h3>
            <div>
                <button class="btn" onclick="sistema.abrirModalTratamento()">
                    <i class="fas fa-plus"></i> Novo Tratamento
                </button>
            </div>
        </div>

        <div class="table-container">

            <h5 style="margin-top: 20px;">Planos de Tratamento</h5>
            <div class="card" style="margin-top: 1rem; margin-left: 0; margin-right: 0;"> 
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Paciente</th>
                            <th>Tratamento</th>
                            <th>Valor Total</th>
                            <th>Valor Restante</th> <th>Status Pag.</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="tabela-tratamentos-body">
                        <tr>
                            <td colspan="7" style="text-align: center; color: #ccc;">Nenhum tratamento registrado</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <h5 style="margin-top: 30px;">Últimos Pagamentos Registrados</h5>
            <div class="card" style="margin-top: 1rem; margin-left: 0; margin-right: 0; margin-bottom: 1rem;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Data Pag.</th>
                            <th>Paciente</th>
                            <th>Valor Pago</th>
                            <th>Forma Pag.</th>
                            <th>Ref. Tratamento</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="tabela-pagamentos-body">
                        <tr>
                            <td colspan="6" style="text-align: center; color: #ccc;">Nenhum pagamento recente</td>
                        </tr>
                    </tbody>
                </table>
            </div>
         </div> </div>

         <div id="estoque" class="content-section">
            <div class="section-header">
                <h3>Gerenciamento de Estoque</h3>
                
                <div class="search-bar-container">
                    <i class="fas fa-search"></i>
                    <input type="text" id="search-estoque-input" placeholder="Buscar item por nome...">
                </div>
                
                <div>
                    <button class="btn" onclick="sistema.abrirModalNovoItem()">
                        <i class="fas fa-plus"></i> Novo Item
                    </button>
                </div>
            </div>

            <p id="estoque-lista-status" style="text-align: center; margin-bottom: 15px; color: #ccc; font-style: italic;"></p>

            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>Categoria</th>
                            <th>Qtd. em Estoque</th>
                            <th>Limite Mínimo</th>
                            <th>Status</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="estoque-tbody">
                        </tbody>
                </table>
            </div>
        </div>
        </div>

    <!-- Modal Paciente -->
    <div id="modal-paciente" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="titulo-modal-paciente">Cadastrar Novo Paciente</h3>
                <span class="close" onclick="fecharModal('modal-paciente')">&times;</span>
            </div>
            <form id="form-paciente">
                <input type="hidden" id="paciente-id">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="paciente-nome">Nome Completo *</label>
                        <input type="text" id="paciente-nome" required>
                    </div>
                    <div class="form-group">
                        <label for="paciente-telefone">Telefone *</label>
                        <input type="tel" id="paciente-telefone" required>
                    </div>
                    <div class="form-group">
                        <label for="paciente-email">Email</label>
                        <input type="email" id="paciente-email">
                    </div>
                    <div class="form-group">
                        <label for="paciente-nascimento">Data de Nascimento *</label>
                        <input type="date" id="paciente-nascimento" required>
                    </div>
                    <div class="form-group">
                        <label for="paciente-cpf">CPF</label>
                        <input type="text" id="paciente-cpf">
                    </div>
                    <div class="form-group">
                        <label for="paciente-endereco">Endereço</label>
                        <input type="text" id="paciente-endereco">
                    </div>
                </div>
                <div class="form-group">
                    <label for="paciente-observacoes">Observações</label>
                    <textarea id="paciente-observacoes" rows="3"></textarea>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn" style="background: #6c757d;" onclick="fecharModal('modal-paciente')">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button type="submit" class="btn">
                        <i class="fas fa-save"></i> Salvar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Consulta -->
  <div id="modal-consulta" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="titulo-modal-consulta">Agendar Nova Consulta</h3>
                <span class="close" onclick="sistema.fecharModalConsulta()">&times;</span>
            </div>
            <form id="form-consulta">
                <input type="hidden" id="consulta-id">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="consulta-paciente">Paciente *</label>
                        <select id="consulta-paciente" required>
                            <option value="">Selecione um paciente</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="consulta-data">Data *</label>
                        <input type="date" id="consulta-data" required>
                    </div>
                    <div class="form-group">
                        <label for="consulta-hora">Hora *</label>
                        <input type="time" id="consulta-hora" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="consulta-tipo">Tipo de Consulta *</label>
                        <select id="consulta-tipo" required>
                            <option value="">Selecione um tipo...</option>
                            
                            <optgroup label="Prevenção">
                                <option value="profilaxia">Profilaxia (limpeza completa)</option>
                                <option value="raspagem_tartaro">Raspagem de tártaro</option>
                                <option value="aplicacao_fluor">Aplicação de flúor</option>
                                <option value="selantes_dentais">Selantes dentais</option>
                                <option value="orientacoes_higiene">Orientações de higiene bucal</option>
                            </optgroup>
                            
                            <optgroup label="Dentística (Restauradora)">
                                <option value="restauracao_resina">Restaurações de resina, amálgama ou outros</option>
                                <option value="clareamento_dental">Clareamento dental</option>
                                <option value="facetas_lentes">Facetas e lentes de contato dentais</option>
                                <option value="ajuste_polimento">Ajuste e polimento de restaurações</option>
                            </optgroup>
                            
                            <optgroup label="Endodontia (Tratamento de canal)">
                                <option value="tratamento_canal">Tratamento de canal</option>
                                <option value="amputacao_radicular">Amputação radicular</option>
                            </optgroup>
                            
                            <optgroup label="Periodontia">
                                <option value="tratamento_gengiva">Tratamento de doenças da gengiva e osso</option>
                                <option value="cirurgia_periodontal">Cirurgia periodontal (gengivoplastia e gengivectomia)</option>
                            </optgroup>
                            
                            <optgroup label="Ortodontia">
                                <option value="instalacao_aparelho">Instalação e manutenção de aparelhos</option>
                                <option value="ajustes_oclusais">Ajustes oclusais</option>
                            </optgroup>
                            
                            <optgroup label="Cirurgia oral e maxilofacial">
                                <option value="extracao_sisos">Extrações dentárias (incluindo "sisos")</option>
                                <option value="bichectomia">Bichectomia</option>
                                <option value="remocao_freio">Remoção de freio lingual ou excesso de gengiva</option>
                                <option value="alveoloplastia">Alveoloplastia</option>
                            </optgroup>
                            
                            <optgroup label="Próteses e Implantodontia">
                                <option value="proteses_totais_parciais">Confecção e instalação de próteses totais (dentaduras) e parciais</option>
                                <option value="implantes_dentarios">Implantes dentários</option>
                            </optgroup>
                            
                            <optgroup label="Estética">
                                <option value="gengivoplastia_estetica">Gengivoplastia e gengivectomia (estética)</option>
                                <option value="aplicacao_botox">Aplicação de botox para fins estéticos</option>
                            </optgroup>
                            
                            <optgroup label="Odontopediatria">
                                <option value="tratamento_dente_leite">Tratamento de dentes de leite e cuidados infantil</option>
                            </optgroup>
                            
                            <optgroup label="Outros">
                                <option value="atendimento_urgencia">Atendimento de urgência</option>
                                <option value="diagnostico_imagem">Diagnóstico por imagem (radiografias)</option>
                                <option value="testes_risco_carie">Testes (risco de cárie, pH e fluxo salivar)</option>
                                <option value="consulta">Consulta (Genérico)</option>
                                <option value="retorno">Retorno (Genérico)</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="consulta-status">Status</label>
                        <select id="consulta-status">
                            <option value="agendada">Agendada</option>
                            <option value="confirmada">Confirmada</option>
                            <option value="em_andamento">Em Andamento</option>
                            <option value="concluida">Concluída</option>
                            <option value="cancelada">Cancelada</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="consulta-duracao">Duração (minutos)</label>
                        <input type="number" id="consulta-duracao" value="60" min="15" step="15">
                    </div>
                </div>
                <div class="form-group">
                    <label for="consulta-observacoes">Observações</label>
                    <textarea id="consulta-observacoes" rows="4"></textarea>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn" style="background: #6c757d;" onclick="fecharModal('modal-consulta')">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button type="submit" class="btn">
                        <i class="fas fa-save"></i> Salvar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="modal-anamnese" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="titulo-modal-anamnese">Ficha de Anamnese</h3>
                <span class="close" onclick="fecharModal('modal-anamnese')">&times;</span>
            </div>
            <form id="form-anamnese">
                <input type="hidden" id="anamnese-paciente-id">
                
                <h4>Dados do Paciente</h4>
                <div class="form-grid">
                    <div class="form-group form-group-span-2">
                        <label for="anamnese-nome">Nome:</label>
                        <input type="text" id="anamnese-nome" readonly>
                    </div>
                    <div class="form-group">
                        <label for="anamnese-cpf">CPF:</label>
                        <input type="text" id="anamnese-cpf" readonly>
                    </div>
                    <div class="form-group">
                        <label for="anamnese-nascimento">Data de Nascimento:</label>
                        <input type="text" id="anamnese-nascimento" readonly>
                    </div>
                    <div class="form-group form-group-span-2">
                        <label for="anamnese-endereco">Endereço:</label>
                        <input type="text" id="anamnese-endereco">
                    </div>
                    <div class="form-group">
                        <label for="anamnese-cep">CEP:</label>
                        <input type="text" id="anamnese-cep">
                    </div>
                    <div class="form-group">
                        <label for="anamnese-fone">Fone:</label>
                        <input type="text" id="anamnese-fone" readonly>
                    </div>
                    <div class="form-group">
                        <label for="anamnese-fone-emergencia">Fone de Emergência:</label>
                        <input type="text" id="anamnese-fone-emergencia">
                    </div>
                    <div class="form-group">
                        <label for="anamnese-falar-com">Falar com:</label>
                        <input type="text" id="anamnese-falar-com">
                    </div>
                    <div class="form-group form-group-span-2">
                        <label for="anamnese-email">Email:</label>
                        <input type="text" id="anamnese-email">
                    </div>
                </div>

                <hr style="margin: 20px 0;">
                
                <h4>Questionário de Saúde</h4>
                <div class="form-check-group">
                    <label>Está em tratamento médico?</label>
                    <div>
                        <input type="checkbox" id="anamnese-tratamento-medico">
                        <label for="anamnese-tratamento-medico">Sim</label>
                        <input type="text" id="anamnese-tratamento-medico-qual" placeholder="Se sim, qual?">
                    </div>
                </div>
                
                <div class="form-check-group">
                    <label>Está tomando algum medicamento?</label>
                    <div>
                        <input type="checkbox" id="anamnese-tomando-medicamento">
                        <label for="anamnese-tomando-medicamento">Sim</label>
                        <input type="text" id="anamnese-tomando-medicamento-qual" placeholder="Se sim, qual?">
                    </div>
                </div>
                
                <div class="form-check-group">
                    <label>Já teve alguma doença (hepatite, chagas, sífilis, febre reumática, câncer, HIV, etc)?</label>
                    <div>
                        <input type="checkbox" id="anamnese-alergia-doenca">
                        <label for="anamnese-alergia-doenca">Sim</label>
                        <input type="text" id="anamnese-alergia-doenca-qual" placeholder="Se sim, qual?">
                    </div>
                </div>
                
                <div class="form-check-group">
                    <label>É diabético?</label>
                    <div>
                        <input type="checkbox" id="anamnese-diabetico">
                        <label for="anamnese-diabetico">Sim</label>
                    </div>
                </div>
                
                <div class="form-check-group">
                    <label>Sabe de alguma doença do coração?</label>
                    <div>
                        <input type="checkbox" id="anamnese-doenca-coracao">
                        <label for="anamnese-doenca-coracao">Sim</label>
                    </div>
                </div>

                <div class="form-check-group">
                    <label>É hipertenso (pressão alta)?</label>
                    <div>
                        <input type="checkbox" id="anamnese-hipertenso">
                        <label for="anamnese-hipertenso">Sim</label>
                    </div>
                </div>
                
                <div class="form-check-group">
                    <label>É hemofílico?</label>
                    <div>
                        <input type="checkbox" id="anamnese-hemofilico">
                        <label for="anamnese-hemofilico">Sim</label>
                    </div>
                </div>
                
                <div class="form-check-group">
                    <label>Seus pés incham com facilidade?</label>
                    <div>
                        <input type="checkbox" id="anamnese-pes-incham">
                        <label for="anamnese-pes-incham">Sim</label>
                    </div>
                </div>

                <div class="form-check-group">
                    <label>Tem tosse persistente?</label>
                    <div>
                        <input type="checkbox" id="anamnese-tosse-persistente">
                        <label for="anamnese-tosse-persistente">Sim</label>
                    </div>
                </div>

                <div class="form-check-group">
                    <label>Tem algum tipo de alergia? (Anestesia, penicilina, etc)</label>
                    <div>
                        <input type="checkbox" id="anamnese-alergia-anestesia">
                        <label for="anamnese-alergia-anestesia">Sim</label>
                        <input type="text" id="anamnese-alergia-anestesia-qual" placeholder="Se sim, qual?">
                    </div>
                </div>
                
                <div class="form-check-group">
                    <label>Já foi submetido a anestesia para tratamento odontológico?</label>
                    <div>
                        <input type="checkbox" id="anamnese-submetido-anestesia">
                        <label for="anamnese-submetido-anestesia">Sim</label>
                    </div>
                </div>
                
                <div class="form-check-group">
                    <label>Já teve hemorragia?</label>
                    <div>
                        <input type="checkbox" id="anamnese-teve-hemorragia">
                        <label for="anamnese-teve-hemorragia">Sim</label>
                    </div>
                </div>
                
                <div class="form-check-group">
                    <label>Tem algum vício (fumo, álcool, drogas)?</label>
                    <div>
                        <input type="checkbox" id="anamnese-tem-vicio">
                        <label for="anamnese-tem-vicio">Sim</label>
                        <input type="text" id="anamnese-tem-vicio-qual" placeholder="Se sim, qual?">
                    </div>
                </div>
                
                <div class="form-check-group">
                    <label>Está grávida?</label>
                    <div>
                        <input type="checkbox" id="anamnese-esta-gravida">
                        <label for="anamnese-esta-gravida">Sim</label>
                    </div>
                </div>
                
                <div class="form-check-group">
                    <label>Sofre de epilepsia?</label>
                    <div>
                        <input type="checkbox" id="anamnese-sofre-epilepsia">
                        <label for="anamnese-sofre-epilepsia">Sim</label>
                    </div>
                </div>
                
                <div class="form-check-group">
                    <label>Tem algo a declarar a respeito de sua saúde que não foi perguntado?</label>
                    <div>
                        <input type="checkbox" id="anamnese-algo-a-declarar">
                        <label for="anamnese-algo-a-declarar">Sim</label>
                        <input type="text" id="anamnese-algo-a-declarar-qual" placeholder="Se sim, qual?">
                    </div>
                </div>
                
                <hr style="margin: 20px 0;">

                <h4>Odontograma (Anotações)</h4>
                <div class="form-group">
                    <label for="anamnese-odontograma-anotacoes">Anotações sobre o Odontograma:</label>
                    <textarea id="anamnese-odontograma-anotacoes" rows="6" placeholder="Ex: Cárie no dente 16, siso 38 para extração..."></textarea>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn" style="background: #6c757d;" onclick="fecharModal('modal-anamnese')">
                        <i class="fas fa-times"></i> Cancelar
                    </button>

                    <button type="button" class="btn" style="background:#0275d8;" onclick="sistema.imprimirAnamnese()">
                        <i class="fas fa-print"></i> Imprimir Ficha
                    </button>

                    <button type="submit" class="btn">
                        <i class="fas fa-save"></i> Salvar Anamnese
                    </button>
                    </div>
            </form>
        </div>
    </div>

                <div id="modal-tratamento" class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 id="titulo-modal-tratamento">Novo Plano de Tratamento</h3>
                            <span class="close" onclick="sistema.fecharModalTratamento()">&times;</span>
                        </div>
                        <form id="form-tratamento">
                            <input type="hidden" id="tratamento-id">
                            
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="tratamento-paciente">Paciente *</label>
                                    <select id="tratamento-paciente" required>
                                        <option value="">Selecione um paciente</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="tratamento-data">Data *</label>
                                    <input type="date" id="tratamento-data" required>
                                </div>
                                <div class="form-group">
                                    <label for="tratamento-valor-total">Valor Total (R$) *</label>
                                    <input type="number" id="tratamento-valor-total" step="0.01" min="0" placeholder="Ex: 1500.00" required>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="tratamento-descricao">Descrição do Tratamento *</label>
                                <textarea id="tratamento-descricao" rows="4" placeholder="Ex: Clareamento dental + 2 Restaurações" required></textarea>
                            </div>

                            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                                <button type="button" class="btn" style="background: #6c757d;" onclick="sistema.fecharModalTratamento()">
                                    <i class="fas fa-times"></i> Cancelar
                                </button>
                                <button type="button" class="btn" onclick="sistema.salvarTratamento()">
                                    <i class="fas fa-save"></i> Salvar Tratamento
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <div id="modal-pagamento" class="modal">
                    <div class="modal-content" style="max-width: 500px;">
                        <div class="modal-header">
                            <h3 id="titulo-modal-pagamento">Registrar Pagamento</h3>
                            <span class="close" onclick="sistema.fecharModalPagamento()">&times;</span>
                        </div>
                        <form id="form-pagamento">
                            <input type="hidden" id="pagamento-tratamento-id">
                            
                            <p>Tratamento de: <strong id="pagamento-paciente-nome">Nome do Paciente</strong></p>
                            <p>Valor Total: <strong id="pagamento-valor-total">R$ 0,00</strong> | Status: <strong id="pagamento-valor-restante" style="color: #e63946;">pendente</strong></p>
                            
                            <hr style="margin: 15px 0;">

                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="pagamento-data">Data do Pagamento *</label>
                                    <input type="date" id="pagamento-data" required>
                                </div>
                                <div class="form-group">
                                    <label for="pagamento-valor">Valor Pago (R$) *</label>
                                    <input type="number" id="pagamento-valor" step="0.01" min="0" placeholder="Ex: 500.00" required>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="pagamento-forma">Forma de Pagamento *</label>
                                <select id="pagamento-forma" required>
                                    <option value="">Selecione a forma...</option>
                                    <option value="Dinheiro">Dinheiro</option>
                                    <option value="Pix">Pix</option>
                                    <option value="Cartão de Débito">Cartão de Débito</option>
                                    <option value="Cartão de Crédito">Cartão de Crédito</option>
                                    <option value="Transferência">Transferência</option>
                                </select>
                            </div>

                            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                                <button type="button" class="btn" style="background: #6c757d;" onclick="sistema.fecharModalPagamento()">
                                    <i class="fas fa-times"></i> Cancelar
                                </button>
                                <button type="button" class="btn" onclick="sistema.salvarPagamento()">
                                    <i class="fas fa-save"></i> Salvar Pagamento
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <div id="modal-paciente-view" class="modal">
                    <div class="modal-content" style="max-width: 900px;"> <div class="modal-header">
                        <h3 id="view-paciente-nome">Prontuário do Paciente</h3>
                        <span class="close" onclick="sistema.fecharModalViewPaciente()">&times;</span>
                    </div>
        
                <div class="modal-body" style="padding-top: 15px;">

                    <div style="display: flex; flex-wrap: wrap; gap: 20px;">
                        
                        <div style="flex: 2; min-width: 400px;">
                            
                            <div class="card" style="padding: 15px; margin-bottom: 20px;">
                                <h5 style="margin-bottom: 10px;">Dados Pessoais</h5>
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label>Nome Completo</label>
                                        <p id="view-paciente-nome-completo">...</p>
                                    </div>
                                    <div class="form-group">
                                        <label>CPF</label>
                                        <p id="view-paciente-cpf">...</p>
                                    </div>
                                    <div class="form-group">
                                        <label>Data de Nasc.</label>
                                        <p id="view-paciente-nascimento">...</p>
                                    </div>
                                    <div class="form-group">
                                        <label>Telefone</label>
                                        <p id="view-paciente-telefone">...</p>
                                    </div>
                                    <div class="form-group">
                                        <label>Email</label>
                                        <p id="view-paciente-email">...</p>
                                    </div>
                                    <div class="form-group">
                                        <label>Endereço</label>
                                        <p id="view-paciente-endereco">...</p>
                                    </div>
                                    <div class="form-group">
                                        <label>Telefone de Emergência</label>
                                        <p id="view-paciente-fone-emergencia">...</p>
                                    </div>
                                    <div class="form-group">
                                        <label>Falar com (Emergência)</label>
                                        <p id="view-paciente-falar-com">...</p>
                                    </div>
                                </div>
                            </div>

                            <div class="card" style="padding: 15px;">
                                <h5 style="margin-bottom: 10px;">Questionário de Saúde (Anamnese)</h5>
                                
                                <ul id="view-anamnese-lista" style="list-style-type: none; padding-left: 0; font-size: 0.9em;">
                                    </ul>

                                <p id="view-anamnese-status">Nenhuma anamnese preenchida.</p>
                            </div>
                        </div>

                        <div style="flex: 1; min-width: 300px;">
                            <div class="card" style="padding: 15px; height: 100%;">
                                <h5 style="margin-bottom: 10px;">Odontograma</h5>
                                
                                <div id="view-odontograma-fundo" style="
                                    width: 100%; 
                                    height: 250px; 
                                    background-image: url('odontograma.jpg'); 
                                    background-size: contain;
                                    background-repeat: no-repeat;
                                    background-position: center;
                                    position: relative;
                                    border: 1px solid #eee;
                                    cursor: zoom-in; 
                                " onclick="sistema.abrirModalZoom('odontograma.jpg')">
                                </div>

                                <div style="margin-top: 10px;">
                                    <label>Anotações sobre o Odontograma:</label>
                                    <p id="view-odontograma-texto-anotacoes" style="font-size: 0.9em; white-space: pre-wrap;"></p>
                                </div>
                            </div>
                        </div>

                    </div> </div> </div>
            </div>

        <div id="modal-imagem-zoom" class="modal-zoom" onclick="sistema.fecharModalZoom()">
            <div class="modal-zoom-content">
                <img id="zoom-image-src" src="" alt="Odontograma Zoom">
            </div>
        </div>

        <div id="modal-agenda-detalhes" class="modal">
            <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header">
                    <h3 id="agenda-detalhes-titulo">Consultas do Dia</h3>
                    <span class="close" onclick="sistema.fecharModalAgendaDia()">&times;</span>
                </div>
                
                <div class="modal-body" style="padding-top: 15px;">
                    <ul id="agenda-detalhes-lista" style="list-style-type: none; padding-left: 0;">
                        </ul>
                </div>
            </div>
        </div>

        <div id="modal-confirmacao" class="modal">
            <div class="modal-content" style="max-width: 450px;">
                <div class="modal-header">
                    <h3 id="confirm-titulo">Confirmar Ação</h3>
                    <span class="close" onclick="sistema.fecharModalConfirmacao()">&times;</span>
                </div>
                
                <div class="modal-body" style="padding-top: 15px;">
                    <p id="confirm-mensagem" style="white-space: pre-wrap; line-height: 1.5;"></p>
                </div>

                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn" style="background: #6c757d;" onclick="sistema.fecharModalConfirmacao()">
                        Cancelar
                    </button>
                    <button type="button" class="btn btn-delete" onclick="sistema.executarConfirmacao()">
                        Confirmar Exclusão
                    </button>
                </div>
            </div>
        </div>

        <div id="modal-item-estoque" class="modal">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h3 id="titulo-modal-item-estoque">Novo Item de Estoque</h3>
                    <span class="close" onclick="sistema.fecharModalEstoque()">&times;</span>
                </div>
                
                <form id="form-item-estoque">
                    <input type="hidden" id="item-id">
                    
                    <div class="form-grid">
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label for="item-nome">Nome do Item *</label>
                            <input type="text" id="item-nome" placeholder="Ex: Luvas de Látex (Caixa c/ 100)" required>
                        </div>
                        <div class="form-group">
                            <label for="item-categoria">Categoria</label>
                            <input type="text" id="item-categoria" placeholder="Ex: Consumíveis">
                        </div>
                        <div class="form-group">
                            <label for="item-limite-minimo">Limite Mínimo de Alerta *</label>
                            <input type="number" id="item-limite-minimo" value="5" min="0" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="item-fornecedor-nome">Fornecedor (Nome)</label>
                            <input type="text" id="item-fornecedor-nome" placeholder="Ex: DentalSpeed">
                        </div>
                        <div class="form-group">
                            <label for="item-fornecedor-telefone">Fornecedor (Telefone)</label>
                            <input type="text" id="item-fornecedor-telefone" placeholder="Ex: (42) 99999-8888">
                        </div>
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label for="item-fornecedor-endereco">Fornecedor (Endereço)</label>
                            <input type="text" id="item-fornecedor-endereco" placeholder="Ex: Rua, Bairro, Cidade">
                        </div>
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label for="item-notas">Notas</label>
                            <textarea id="item-notas" rows="3" placeholder="Qualquer observação sobre o item"></textarea>
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                        <button type="button" class="btn" style="background: #6c757d;" onclick="sistema.fecharModalEstoque()">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                        <button type="submit" class="btn">
                            <i class="fas fa-save"></i> Salvar Item
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div id="modal-atualizar-estoque" class="modal">
            <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header">
                    <h3 id="titulo-modal-atualizar-estoque">Atualizar Quantidade</h3>
                    <span class="close" onclick="sistema.fecharModalAtualizarEstoque()">&times;</span>
                </div>
                
                <form id="form-atualizar-estoque">
                    <input type="hidden" id="atualizar-item-id">
                    
                    <p>Item: <strong id="atualizar-item-nome">[Nome do Item]</strong></p>
                    <p>Qtd. Atual: <strong id="atualizar-item-qtd" style="font-size: 1.2em;">0</strong></p>
                    
                    <hr style="margin: 15px 0; border-color: rgba(255,255,255,0.2);">

                    <div class="form-grid">
                        <div class="form-group">
                            <label for="atualizar-tipo">Tipo de Movimentação *</label>
                            <select id="atualizar-tipo" required 
                                    onchange="document.getElementById('campo-valor-lote').style.display = this.value === 'entrada' ? 'block' : 'none'">
                                <option value="entrada">Entrada (Compra)</option>
                                <option value="saida">Saída (Uso)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="atualizar-quantidade">Quantidade *</label>
                            <input type="number" id="atualizar-quantidade" min="1" value="1" required>
                        </div>
                    </div>

                    <div class="form-group" id="campo-valor-lote">
                        <label for="item-valor-lote">Valor Total Pago pelo Lote (R$)</label>
                        <input type="number" id="item-valor-lote" step="0.01" min="0" placeholder="Ex: 150.50">
                    </div>
                    <div class="form-group">
                        <label for="atualizar-notas">Notas da Movimentação (Opcional)</label>
                        <input type="text" id="atualizar-notas" placeholder="Ex: Compra NF-123 ou Uso no Paciente X">
                    </div>

                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                        <button type="button" class="btn" style="background: #6c757d;" onclick="sistema.fecharModalAtualizarEstoque()">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                        <button type="submit" class="btn">
                            <i class="fas fa-check"></i> Confirmar Atualização
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div id="modal-historico-compras" class="modal">
            <div class="modal-content" style="max-width: 700px;">
                <div class="modal-header">
                    <h3 id="titulo-modal-historico">Histórico de Compras</h3>
                    <span class="close" onclick="sistema.fecharModalHistorico()">&times;</span>
                </div>
                <div class="modal-body" style="padding-top: 15px;">
                    <p>Item: <strong id="historico-item-nome">[Nome do Item]</strong></p>
                    <div class="table-container" style="max-height: 400px; margin-top: 15px;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Data Compra</th>
                                    <th>Qtd. Comprada</th>
                                    <th>Valor do Lote</th>
                                    <th>Fornecedor/Nota</th>
                                </tr>
                            </thead>
                            <tbody id="historico-tbody">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="modal-item-view" class="modal">
            <div class="modal-content" style="max-width: 900px;"> <div class="modal-header">
                    <h3 id="view-item-nome">Prontuário do Item</h3>
                    <span class="close" onclick="sistema.fecharModalViewItem()">&times;</span>
                </div>
                
                <div class="modal-body" style="padding-top: 15px;">
                    <div style="display: flex; flex-wrap: wrap; gap: 20px;">
                        
                        <div style="flex: 2; min-width: 400px;">
                            
                            <div class="card" style="padding: 15px; margin-bottom: 20px;">
                                <h5 style="margin-bottom: 10px;">Detalhes do Item</h5>
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label>Nome do Item</label>
                                        <p id="view-item-nome-completo">---</p>
                                    </div>
                                    <div class="form-group">
                                        <label>Categoria</label>
                                        <p id="view-item-categoria">---</p>
                                    </div>
                                    <div class="form-group">
                                        <label>Qtd. em Estoque</label>
                                        <p id="view-item-quantidade" style="font-weight: bold; font-size: 1.2em;">---</p>
                                    </div>
                                    <div class="form-group">
                                        <label>Limite Mínimo</label>
                                        <p id="view-item-limite">---</p>
                                    </div>
                                </div>
                            </div>

                            <div class="card" style="padding: 15px; margin-bottom: 20px;">
                                <h5 style="margin-bottom: 10px;">Fornecedor Preferencial</h5>
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label>Nome</label>
                                        <p id="view-fornecedor-nome">---</p>
                                    </div>
                                    <div class="form-group">
                                        <label>Telefone</label>
                                        <p id="view-fornecedor-telefone">---</p>
                                    </div>
                                    <div class="form-group" style="grid-column: 1 / -1;">
                                        <label>Endereço</label>
                                        <p id="view-fornecedor-endereco">---</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card" style="padding: 15px;">
                                <h5 style="margin-bottom: 10px;">Notas</h5>
                                <p id="view-item-notas" style="white-space: pre-wrap; font-size: 0.9em;">---</p>
                            </div>

                        </div>

                        <div style="flex: 1; min-width: 300px;">
                            <div class="card" style="padding: 15px; height: 100%;">
                                <h5 style="margin-bottom: 10px;">Histórico de Compras</h5>
                                <div class="table-container" style="max-height: 400px;">
                                    <table class="data-table">
                                        <thead>
                                            <tr>
                                                <th>Data</th>
                                                <th>Qtd.</th>
                                                <th>Valor</th>
                                            </tr>
                                        </thead>
                                        <tbody id="view-historico-tbody">
                                            </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                    </div> </div> </div>
        </div>

    <script>

class SistemaClinica {
    
    constructor() {
        this.currentDate = new Date();
        this.currentMonth = this.currentDate.getMonth();
        this.currentYear = this.currentDate.getFullYear();
        this.confirmCallback = null;
        this.init(); // O init() vai carregar os dados
    }

    // --- FUNÇÕES DE CONTROLE DA JANELA ---
        minimizeWindow() {
            window.api.minimizeWindow();
        }
        
        maximizeWindow() {
            window.api.maximizeWindow();
        }
        
        closeWindow() {
            window.api.closeWindow();
        }

    async init() {
        this.setupEventListeners();
        
        // Carrega todos os dados do banco ao iniciar
        await this.updateDashboard(); 
        await this.loadPacientes(); 
        await this.loadConsultas();
        await this.generateCalendar();
        await this.updatePacientesSelect();
        await this.carregarTratamentos();
        await this.carregarPagamentosRecentes();
        await this.loadEstoque();
    }

    setupEventListeners() {
        // Navigation
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                this.switchSection(link.dataset.section);
            });
        });

        document.getElementById('search-paciente-input').addEventListener('keyup', () => {
            this.loadPacientes();
        });

        // Forms
        document.getElementById('form-paciente').addEventListener('submit', (e) => {
            e.preventDefault();
            this.savePaciente();
        });

        document.getElementById('form-consulta').addEventListener('submit', (e) => {
            e.preventDefault();
            this.saveConsulta();
        });

        document.getElementById('form-anamnese').addEventListener('submit', (e) => {
                e.preventDefault();
                this.saveAnamnese();
            });

        // Data de hoje no modal de consulta
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('consulta-data').value = today;

        // --- LIGA OS BOTÕES DA JANELA ---
            document.getElementById('btn-minimize').addEventListener('click', () => {
                this.minimizeWindow();
            });
            document.getElementById('btn-maximize').addEventListener('click', () => {
                this.maximizeWindow();
            });
            document.getElementById('btn-close').addEventListener('click', () => {
                this.closeWindow();
            });
        
        // Ouvinte da barra de busca de Estoque
        document.getElementById('search-estoque-input').addEventListener('keyup', () => {
            this.loadEstoque();
        });

        document.getElementById('form-item-estoque').addEventListener('submit', (e) => {
            e.preventDefault();
            this.salvarItem();
        });
        
        document.getElementById('form-atualizar-estoque').addEventListener('submit', (e) => {
            e.preventDefault();
            this.atualizarQuantidadeEstoque();
        });
        
        document.getElementById('btn-exportar-backup').addEventListener('click', () => {
            this.exportarBackup();
        });
    }

    switchSection(sectionName) {
        // ... (Seu código para 'active' nas 'nav-link' e 'content-section') ...
        document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
        document.querySelector(`[data-section="${sectionName}"]`).classList.add('active');
        document.querySelectorAll('.content-section, .dashboard').forEach(section => section.classList.remove('active'));
        const targetSection = document.getElementById(sectionName);
        if (targetSection) targetSection.classList.add('active');

        // ... (Seu código para 'page-title' e 'page-subtitle') ...
        const titles = {
            dashboard: { title: 'Dashboard', subtitle: 'Visão geral da clínica' },
            pacientes: { title: 'Pacientes', subtitle: 'Gerenciamento de pacientes' },
            consultas: { title: 'Consultas', subtitle: 'Registro de atendimentos' },
            agenda: { title: 'Agenda', subtitle: 'Calendário de consultas' },
            relatorios: { title: 'Relatórios', subtitle: 'Estatísticas e análises' },
            financeiro: { title: 'Financeiro', subtitle: 'Gerenciamento de tratamentos e pagamentos' },
            estoque: { title: 'Estoque', subtitle: 'Controle de materiais da clínica' }
        };
        const titleInfo = titles[sectionName] || titles.dashboard;
        document.getElementById('page-title').textContent = titleInfo.title;
        document.getElementById('page-subtitle').textContent = titleInfo.subtitle;


        // Atualiza o calendário ao visitar a agenda
        if (sectionName === 'agenda') {
            this.generateCalendar();
        }
    }

    abrirModalPaciente() {
        // 1. Limpa o formulário de qualquer dado de edição anterior
        document.getElementById('form-paciente').reset();
        
        // 2. Garante que o ID do paciente esteja vazio
        document.getElementById('paciente-id').value = '';
        
        // 3. Define o título do modal para "Novo"
        document.getElementById('titulo-modal-paciente').textContent = 'Cadastrar Novo Paciente';
        
        // 4. Abre o modal
        document.getElementById('modal-paciente').style.display = 'flex';
    }

    /**
     * Abre o modal de confirmação
     * @param {string} mensagem - A pergunta (ex: "Tem certeza?")
     * @param {function} callback - A função que deve ser executada se o usuário clicar em "Confirmar"
     */
    abrirModalConfirmacao(mensagem, callback) {
        // 1. Armazena a função que devemos executar
        this.confirmCallback = callback;
        
        // 2. Define a mensagem
        document.getElementById('confirm-mensagem').textContent = mensagem;

        // 3. Abre o modal
        document.getElementById('modal-confirmacao').style.display = 'flex';
    }

    fecharModalConfirmacao() {
        document.getElementById('modal-confirmacao').style.display = 'none';
        this.confirmCallback = null; // Limpa a ação
    }

    async executarConfirmacao() {
        if (this.confirmCallback) {
            await this.confirmCallback(); // 1. Executa a ação (ex: a exclusão)
        }
        this.fecharModalConfirmacao(); // 2. Fecha o modal
    }

    async savePaciente() {
            // Pega os dados do formulário
            const id = document.getElementById('paciente-id').value;
            const nome = document.getElementById('paciente-nome').value;
            const telefone = document.getElementById('paciente-telefone').value;
            const email = document.getElementById('paciente-email').value;
            const nascimento = document.getElementById('paciente-nascimento').value;
            const cpf = document.getElementById('paciente-cpf').value;
            const endereco = document.getElementById('paciente-endereco').value;
            const observacoes = document.getElementById('paciente-observacoes').value;
            
            let sql = '';
            let params = [];
            let message = '';

            // Pega a data de hoje (para novos pacientes)
            const dataCadastro = new Date().toISOString().split('T')[0];

            try {
                if (id) {
                    // --- EDITAR PACIENTE ---
                    sql = `
                        UPDATE pacientes SET 
                        nome = ?, telefone = ?, email = ?, nascimento = ?, cpf = ?, endereco = ?, observacoes = ? 
                        WHERE id = ?
                    `;
                    params = [nome, telefone, email, nascimento, cpf, endereco, observacoes, id];
                    message = 'Paciente atualizado com sucesso!';
                } else {
                    // --- NOVO PACIENTE ---
                    const novoId = 'pid_' + new Date().getTime(); // Cria ID único
                    sql = `
                        INSERT INTO pacientes (id, nome, telefone, email, nascimento, cpf, endereco, observacoes, dataCadastro)
                        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
                    `;
                    params = [novoId, nome, telefone, email, nascimento, cpf, endereco, observacoes, dataCadastro];
                    message = 'Paciente salvo com sucesso!';
                }

                await window.api.run(sql, params);
                
                this.showMessage(message, 'success');
                this.fecharModal('modal-paciente');
                this.loadPacientes(); // Recarrega a lista
                this.updatePacientesSelect(); // Atualiza os dropdowns

            } catch (err) {
                console.error('Erro ao salvar paciente:', err.message);
                this.showMessage(`Erro ao salvar paciente: ${err.message}`, 'error');
            }
        }

    async loadPacientes() {
        const tbody = document.getElementById('pacientes-tbody');
        const searchTerm = document.getElementById('search-paciente-input').value;
        const statusText = document.getElementById('pacientes-lista-status'); // <-- NOVA LINHA

        let sql = `SELECT id, nome, telefone, email, nascimento FROM pacientes`;
        const params = [];

        if (searchTerm) {
            sql += ` WHERE nome LIKE ? ORDER BY nome ASC`;
            params.push(`%${searchTerm}%`);
            statusText.textContent = `Mostrando resultados para "${searchTerm}"...`; // <-- NOVA LINHA
        } else {
            sql += ` ORDER BY dataCadastro DESC NULLS LAST LIMIT 20`; 
            statusText.textContent = `Mostrando os 20 pacientes mais recentes.`; 
        }

        try {
            const pacientes = await window.api.all(sql, params);
            tbody.innerHTML = ''; 

            if (pacientes && pacientes.length > 0) {
                pacientes.forEach(paciente => {
                    const row = tbody.insertRow();
                    const dataNasc = paciente.nascimento ? paciente.nascimento.split('-').reverse().join('/') : '-';
                    
                    row.innerHTML = `
                        <td>
                            <a href="#" class="link-paciente" onclick="event.preventDefault(); sistema.abrirModalViewPaciente('${paciente.id}')">
                                ${paciente.nome}
                            </a>
                        </td>
                        <td>${paciente.telefone || '-'}</td>
                        <td>${paciente.email || '-'}</td>
                        <td>${dataNasc}</td>
                        
                        <td class="action-buttons">
                            <button class="btn-sm" style="background: #17a2b8;" title="Ver Anamnese" onclick="sistema.abrirModalAnamnese('${paciente.id}')">
                                <i class="fas fa-file-medical"></i>
                            </button>
                            <button class="btn-sm btn-edit" title="Editar Paciente" onclick="sistema.editarPaciente('${paciente.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-sm btn-delete" title="Excluir Paciente" onclick="sistema.excluirPaciente('${paciente.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                });
            } else {
                tbody.innerHTML = `<tr><td colspan="5" style="text-align: center; color: #ccc;">Nenhum paciente encontrado.</td></tr>`;
                if (!searchTerm) {
                    statusText.textContent = 'Nenhum paciente cadastrado ainda.'; // <-- NOVA LINHA
                }
            }
        } catch (err) {
            console.error('Erro ao carregar pacientes:', err.message);
            tbody.innerHTML = `<tr><td colspan="5" style="text-align: center; color: red;">Erro ao carregar pacientes.</td></tr>`;
        }
    }

    async abrirModalViewPaciente(pacienteId) {
        console.log(`Buscando dados completos para o paciente ID: ${pacienteId}`);
        
        // --- 1. SQL CORRIGIDO ---
        // Usamos 'p.nome AS pacienteNome' para dar um apelido e evitar o conflito
        const sql = `
            SELECT 
                p.id, 
                p.nome AS pacienteNome,
                p.cpf AS pacienteCpf,
                p.nascimento AS pacienteNascimento,
                p.telefone AS pacienteTelefone,
                p.email AS pacienteEmail,
                p.endereco AS pacienteEndereco,
                a.* /* Pega todos os campos da anamnese (fone_emergencia, falar_com, etc.) */
            FROM pacientes p
            LEFT JOIN anamnese a ON p.id = a.pacienteId
            WHERE p.id = ?
        `;

        try {
            const resultados = await window.api.all(sql, [pacienteId]);
            if (!resultados || resultados.length === 0) {
                alert('Erro: Paciente não encontrado no banco de dados.');
                return;
            }
            
            const dados = resultados[0]; 
            const get = (key) => (dados[key] || '---'); 
            
            // --- 3. PREENCHIMENTO CORRIGIDO ---
            // Agora usamos os "apelidos" (pacienteNome, pacienteCpf, etc.)
            document.getElementById('view-paciente-nome').textContent = `Prontuário de: ${get('pacienteNome')}`;
            document.getElementById('view-paciente-nome-completo').textContent = get('pacienteNome');
            document.getElementById('view-paciente-cpf').textContent = get('pacienteCpf');
            document.getElementById('view-paciente-nascimento').textContent = dados.pacienteNascimento ? dados.pacienteNascimento.split('-').reverse().join('/') : '---';
            document.getElementById('view-paciente-telefone').textContent = get('pacienteTelefone');
            document.getElementById('view-paciente-email').textContent = get('pacienteEmail');
            document.getElementById('view-paciente-endereco').textContent = get('pacienteEndereco');
            
            // Estes dados vêm da anamnese (tabela 'a'), então os nomes originais funcionam
            document.getElementById('view-paciente-fone-emergencia').textContent = get('fone_emergencia');
            document.getElementById('view-paciente-falar-com').textContent = get('falar_com');

            // --- 4. Preenche a Anamnese (Código não muda) ---
            const listaAnamnese = document.getElementById('view-anamnese-lista');
            const statusAnamnese = document.getElementById('view-anamnese-status');
            
            if (dados.pacienteId) { 
                statusAnamnese.style.display = 'none'; 
                listaAnamnese.innerHTML = ''; 
                
                const addAnamneseItem = (texto, condicao, detalhe) => {
                    if (condicao == 1) { 
                        let item = document.createElement('li');
                        item.style.color = 'red'; 
                        item.style.fontWeight = 'bold';
                        item.textContent = `⚠️ ${texto}`;
                        if (detalhe) item.textContent += `: ${detalhe}`;
                        listaAnamnese.appendChild(item);
                    }
                };
                
                addAnamneseItem('Está em tratamento médico', dados.tratamento_medico, dados.tratamento_medico_qual);
                addAnamneseItem('Está tomando medicamento', dados.tomando_medicamento, dados.tomando_medicamento_qual);
                addAnamneseItem('Tem alergia/doença', dados.alergia_doenca, dados.alergia_doenca_qual);
                addAnamneseItem('É diabético', dados.diabetico);
                addAnamneseItem('Tem doença do coração', dados.doenca_coracao);
                addAnamneseItem('É hipertenso', dados.hipertenso);
                addAnamneseItem('É hemofílico', dados.hemofilico);
                addAnamneseItem('Pés incham com facilidade', dados.pes_incham);
                addAnamneseItem('Tosse persistente', dados.tosse_persistente);
                addAnamneseItem('Tem alergia a anestesia', dados.alergia_anestesia, dados.alergia_anestesia_qual);
                addAnamneseItem('Teve hemorragia', dados.teve_hemorragia);
                addAnamneseItem('Tem vício', dados.tem_vicio, dados.tem_vicio_qual);
                addAnamneseItem('Está grávida', dados.esta_gravida);
                addAnamneseItem('Sofre de epilepsia', dados.sofre_epilepsia);
                addAnamneseItem('Algo a declarar', dados.algo_a_declarar, dados.algo_a_declarar_qual);
                
                if(listaAnamnese.children.length === 0) {
                    listaAnamnese.innerHTML = '<li style="color: green;">Paciente não reportou nenhuma condição adversa.</li>';
                }

            } else {
                statusAnamnese.style.display = 'block';
                listaAnamnese.innerHTML = '';
            }

            // --- 5. Preenche o Odontograma (Código não muda) ---
            const anotacoes = get('odontograma_anotacoes');
            document.getElementById('view-odontograma-texto-anotacoes').textContent = anotacoes !== '---' ? anotacoes : 'Nenhuma anotação.';

            // --- 6. Abre o Modal (Código não muda) ---
            document.getElementById('modal-paciente-view').style.display = 'flex';

        } catch (err) {
            console.error('Erro ao buscar dados completos do paciente:', err.message);
            alert('Erro ao carregar o prontuário. Veja o console.');
        }
    }

    fecharModalViewPaciente() {
        document.getElementById('modal-paciente-view').style.display = 'none';
    }

    async abrirModalAgendaDia(dataISO) {
        const [ano, mes, dia] = dataISO.split('-');
        const dataFormatada = `${dia}/${mes}/${ano}`;
        
        document.getElementById('agenda-detalhes-titulo').textContent = `Consultas do dia ${dataFormatada}`;
        const lista = document.getElementById('agenda-detalhes-lista');
        lista.innerHTML = '<li>Buscando consultas...</li>'; // Feedback
        
        try {
            // Busca as consultas E o nome do paciente
            const sql = `
                SELECT c.hora, c.tipo, p.nome 
                FROM consultas c 
                JOIN pacientes p ON c.pacienteId = p.id 
                WHERE c.data = ? 
                ORDER BY c.hora ASC
            `;
            const consultas = await window.api.all(sql, [dataISO]);

            if (consultas && consultas.length > 0) {
                lista.innerHTML = ''; // Limpa a lista
                consultas.forEach(c => {
                    const item = document.createElement('li');
                    item.style.borderBottom = '1px solid rgba(255, 255, 255, 0.1)';
                    item.style.padding = '8px 0';
                    item.innerHTML = `<strong>${c.hora}</strong> - ${c.nome} (<em>${c.tipo}</em>)`;
                    lista.appendChild(item);
                });
            } else {
                lista.innerHTML = '<li>Nenhuma consulta agendada para este dia.</li>';
            }
            
            document.getElementById('modal-agenda-detalhes').style.display = 'flex';

        } catch (err) {
            console.error('Erro ao buscar consultas do dia:', err.message);
            lista.innerHTML = '<li style="color: red;">Erro ao carregar consultas.</li>';
        }
    }

     fecharModalAgendaDia() {
        document.getElementById('modal-agenda-detalhes').style.display = 'none';
    }

    async editarPaciente(id) {
        try {
            const resultados = await window.api.all('SELECT * FROM pacientes WHERE id = ?', [id]);
            if (!resultados.length) return;
            const p = resultados[0];
            
            document.getElementById('paciente-id').value = p.id;
            document.getElementById('paciente-nome').value = p.nome;
            document.getElementById('paciente-telefone').value = p.telefone;
            document.getElementById('paciente-email').value = p.email || '';
            document.getElementById('paciente-nascimento').value = p.nascimento || '';
            document.getElementById('paciente-cpf').value = p.cpf || '';
            document.getElementById('paciente-endereco').value = p.endereco || '';
            document.getElementById('paciente-observacoes').value = p.observacoes || '';
            document.getElementById('titulo-modal-paciente').textContent = 'Editar Paciente';
            
            this.abrirModal('modal-paciente');
        } catch (err) {
            console.error('Erro ao buscar paciente:', err);
        }
    }

    async excluirPaciente(id) {
        
        const mensagem = 'Tem certeza que deseja excluir este paciente?\n\nTODOS os seus dados (consultas, anamnese, tratamentos e pagamentos) serão apagados para sempre. Esta ação não pode ser desfeita.';

        const exclusaoCallback = async () => {
            try {
                // Busca todos os tratamentos do paciente
                const tratamentos = await window.api.all('SELECT id FROM tratamentos WHERE pacienteId = ?', [id]);
                if (tratamentos && tratamentos.length > 0) {
                    const tratIds = tratamentos.map(t => t.id);
                    // Apaga todos os pagamentos ligados a esses tratamentos
                    await window.api.run(`DELETE FROM pagamentos WHERE tratamentoId IN (${tratIds.map(() => '?').join(',')})`, tratIds);
                }
                // B. Apaga os dados "filhos"
                await window.api.run('DELETE FROM tratamentos WHERE pacienteId = ?', [id]);
                await window.api.run('DELETE FROM consultas WHERE pacienteId = ?', [id]);
                await window.api.run('DELETE FROM anamnese WHERE pacienteId = ?', [id]);

                // C. Finalmente, apaga o paciente
                await window.api.run('DELETE FROM pacientes WHERE id = ?', [id]);
                
                console.log('Paciente e todos os dados associados excluídos com sucesso.');
                // D. Recarrega tudo
                this.loadPacientes(); // Recarrega a lista de pacientes
                this.updatePacientesSelect(); // Atualiza os dropdowns em outros modais
                this.updateDashboard(); // Atualiza os contadores
                
            } catch (err) {
                console.error('Erro ao excluir paciente:', err.message);
                // this.showMessage('Erro ao excluir paciente: ' + err.message, 'error');
            }
        };

        this.abrirModalConfirmacao(
            mensagem,
            exclusaoCallback 
        );
    }

    async carregarTratamentos() {
        const tbody = document.getElementById('tabela-tratamentos-body');
        
        const sql = `
            SELECT 
                t.id, 
                t.data, 
                p.nome AS pacienteNome, 
                t.descricao, 
                t.valor_total, 
                t.status_pagamento,
                COALESCE(SUM(pg.valor_pago), 0) AS totalPago
            FROM tratamentos t
            JOIN pacientes p ON t.pacienteId = p.id
            LEFT JOIN pagamentos pg ON t.id = pg.tratamentoId
            GROUP BY t.id
            ORDER BY t.data DESC
        `;
        
        try {
            const tratamentos = await window.api.all(sql, []);
            
            tbody.innerHTML = ''; 
            
            if (tratamentos && tratamentos.length > 0) {
                tratamentos.forEach(t => {
                    const row = tbody.insertRow();
                    
                    const dataFormatada = t.data.split('-').reverse().join('/');
                    const valorFormatado = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(t.valor_total);

                    // --- NOVO CÁLCULO E FORMATAÇÃO ---
                    const valorRestante = t.valor_total - t.totalPago;
                    const valorRestanteFormatado = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(valorRestante);

                    row.innerHTML = `
                        <td>${dataFormatada}</td>
                        <td>${t.pacienteNome}</td>
                        <td>${t.descricao}</td>
                        <td>${valorFormatado}</td>
                        <td style="color: ${valorRestante > 0 ? 'red' : 'green'}; font-weight: bold;">${valorRestanteFormatado}</td> <td>${t.status_pagamento}</td>
                        <td style="display: flex; gap: 5px;">
                            <button class="btn-sm" title="Registrar Pagamento" onclick="sistema.abrirModalPagamento(${t.id}, '${t.pacienteNome}', ${t.valor_total}, ${valorRestante}, '${t.status_pagamento}')">
                                <i class="fas fa-dollar-sign"></i>
                            </button>
                            <button class="btn-sm btn-danger" title="Excluir Tratamento" onclick="sistema.excluirTratamento(${t.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                            <button class="btn-sm" style="background:#0275d8;" title="Imprimir Contrato" onclick="sistema.imprimirContrato(${t.id})">
                                <i class="fas fa-print"></i>
                            </button>
                        </td>
                    `;
                });
            } else {
                // CORREÇÃO: O colspan agora precisa ser 7 por causa da nova coluna.
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: grey;">Nenhum tratamento registrado</td></tr>';
            }
        } catch (err) {
            console.error('Erro ao carregar tratamentos:', err.message);
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: red;">Erro ao carregar dados</td></tr>';
        }
    }

    async abrirModalTratamento() {
        const selectPacientes = document.getElementById('tratamento-paciente');
        selectPacientes.options.length = 1; 
        
        try {
            // CORRIGIDO: de window.api.dbQuery para window.api.all
            const pacientes = await window.api.all('SELECT id, nome FROM pacientes ORDER BY nome ASC', []);
            
            if (pacientes) {
                pacientes.forEach(paciente => {
                    const option = new Option(paciente.nome, paciente.id); 
                    selectPacientes.add(option);
                });
            }
            
            document.getElementById('form-tratamento').reset();
            document.getElementById('tratamento-id').value = '';
            document.getElementById('modal-tratamento').style.display = 'flex';
            
        } catch (err) {
            console.error('Erro ao carregar pacientes:', err.message);
        }
    }

    fecharModalTratamento() {
        document.getElementById('modal-tratamento').style.display = 'none';
    }

    async salvarTratamento() {
        const pacienteId = document.getElementById('tratamento-paciente').value;
        const data = document.getElementById('tratamento-data').value;
        const valor_total = document.getElementById('tratamento-valor-total').value;
        const descricao = document.getElementById('tratamento-descricao').value; 
        
        if (!pacienteId || !data || !valor_total || !descricao) {
            console.error('Por favor, preencha todos os campos obrigatórios.');
            return; 
        }
        
        const sql = `
            INSERT INTO tratamentos (pacienteId, data, descricao, valor_total, status_pagamento)
            VALUES (?, ?, ?, ?, 'pendente')
        `;
        
        try {
           
            await window.api.run(sql, [pacienteId, data, descricao, valor_total]);
            
            console.log('Tratamento salvo com sucesso!');
            this.fecharModalTratamento();
            this.carregarTratamentos(); 
            
        } catch (err) {
            console.error('Erro ao salvar tratamento:', err.message);
        }
    }

    async excluirTratamento(id) {

        const exclusaoCallback = async () => {
            try {
                await window.api.run('DELETE FROM pagamentos WHERE tratamentoId = ?', [id]);
                await window.api.run('DELETE FROM tratamentos WHERE id = ?', [id]);
                
                console.log('Tratamento excluído com sucesso.');
                
                this.carregarTratamentos(); 
                this.carregarPagamentosRecentes();
                
            } catch (err) {
                console.error('Erro ao excluir tratamento:', err.message);
            }
        };

        this.abrirModalConfirmacao(
            'Tem certeza que deseja excluir este tratamento?\n\nTodos os pagamentos associados também serão excluídos. Esta ação não pode ser desfeita.',
            exclusaoCallback // Passa a função
        );
    }

    abrirModalPagamento(id, nomePaciente, valorTotal, valorRestante, status) {
        // Limpa o formulário e preenche os dados
        document.getElementById('form-pagamento').reset();
        document.getElementById('pagamento-tratamento-id').value = id;

        const valorTotalFormatado = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(valorTotal);
        const valorRestanteFormatado = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(valorRestante);
        
        document.getElementById('pagamento-paciente-nome').textContent = nomePaciente;
        document.getElementById('pagamento-valor-total').textContent = valorTotalFormatado;
        document.getElementById('pagamento-valor-restante').textContent = valorRestanteFormatado;
        
        document.getElementById('modal-pagamento').style.display = 'flex';
    }

    fecharModalPagamento() {
         document.getElementById('modal-pagamento').style.display = 'none';
    }

    // =============================================
    //   INÍCIO: MÉTODOS DO MÓDULO DE ESTOQUE (ATUALIZADO)
    // =============================================
    async loadEstoque() {
        const tbody = document.getElementById('estoque-tbody');
        const searchTerm = document.getElementById('search-estoque-input').value;
        const statusText = document.getElementById('estoque-lista-status');

        let sql = `SELECT * FROM estoque`;
        const params = [];

        if (searchTerm) {
            sql += ` WHERE nome LIKE ? ORDER BY nome ASC`;
            params.push(`%${searchTerm}%`);
            statusText.textContent = `Mostrando resultados para "${searchTerm}"...`;
        } else {
            sql += ` ORDER BY nome ASC`;
            statusText.textContent = `Mostrando todos os itens do estoque.`;
        }

        try {
            const itens = await window.api.all(sql, params);
            tbody.innerHTML = ''; // Limpa a tabela

            if (itens && itens.length > 0) {
                itens.forEach(item => {
                    const row = tbody.insertRow();
                    
                    let statusCor = 'green';
                    let statusTexto = 'OK';
                    
                    if (item.quantidade <= 0) {
                        statusCor = 'red';
                        statusTexto = 'Zerado';
                    } else if (item.quantidade <= item.limite_minimo) {
                        statusCor = 'orange';
                        statusTexto = 'Estoque Baixo';
                    }

                    row.innerHTML = `
                        <td>${item.nome}</td>
                        <td>${item.categoria || '-'}</td>
                        <td style="font-weight: bold;">${item.quantidade}</td>
                        <td>${item.limite_minimo}</td>
                        <td style="color: ${statusCor}; font-weight: bold;">${statusTexto}</td>
                        
                        <td class="action-buttons">
                            <button class="btn-sm" style="background: #17a2b8;" title="Ver Detalhes do Item" onclick="sistema.abrirModalViewItem(${item.id})">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn-sm" style="background: #28a745;" title="Dar Entrada/Saída" onclick="sistema.abrirModalAtualizarEstoque(${item.id}, '${item.nome}', ${item.quantidade})">
                                <i class="fas fa-exchange-alt"></i>
                            </button>
                            <button class="btn-sm" style="background: #007bff;" title="Histórico de Compras" onclick="sistema.abrirModalHistorico(${item.id})">
                                <i class="fas fa-history"></i>
                            </button>
                            <button class="btn-sm btn-edit" title="Editar Item" onclick="sistema.editarItemEstoque(${item.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-sm btn-delete" title="Excluir Item" onclick="sistema.excluirItemEstoque(${item.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                });
            } else {
                let mensagem = searchTerm ? 'Nenhum item encontrado com esse nome.' : 'Nenhum item cadastrado no estoque.';
                tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; color: #ccc;">${mensagem}</td></tr>`;
                if (!searchTerm) {
                    statusText.textContent = 'Nenhum item cadastrado ainda.';
                }
            }
        } catch (err) {
            console.error('Erro ao carregar estoque:', err.message);
            tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; color: red;">Erro ao carregar estoque.</td></tr>`;
        }
    }

    abrirModalNovoItem() {
        document.getElementById('form-item-estoque').reset();
        document.getElementById('item-id').value = '';
        document.getElementById('titulo-modal-item-estoque').textContent = 'Novo Item de Estoque';
        document.getElementById('modal-item-estoque').style.display = 'flex';
    }

    fecharModalEstoque() {
        document.getElementById('modal-item-estoque').style.display = 'none';
    }

    async salvarItem() {
        // Pega os dados do modal
        const id = document.getElementById('item-id').value;
        const nome = document.getElementById('item-nome').value;
        const categoria = document.getElementById('item-categoria').value;
        const limite_minimo = document.getElementById('item-limite-minimo').value;
        const fornecedor_nome = document.getElementById('item-fornecedor-nome').value;
        const fornecedor_telefone = document.getElementById('item-fornecedor-telefone').value;
        const fornecedor_endereco = document.getElementById('item-fornecedor-endereco').value;
        const notas = document.getElementById('item-notas').value;
        const dataAtual = new Date().toISOString().split('T')[0];

        let sql = '';
        let params = [];
        let message = '';

        try {
            if (id) {
                // --- EDITAR ITEM ---
                sql = `
                    UPDATE estoque SET 
                    nome = ?, categoria = ?, limite_minimo = ?, 
                    fornecedor_nome = ?, fornecedor_telefone = ?, fornecedor_endereco = ?, 
                    notas = ?, ultima_atualizacao = ?
                    WHERE id = ?
                `;
                params = [nome, categoria, limite_minimo, fornecedor_nome, fornecedor_telefone, fornecedor_endereco, notas, dataAtual, id];
                message = 'Item atualizado com sucesso!';
            } else {
                // --- NOVO ITEM ---
                sql = `
                    INSERT INTO estoque (nome, categoria, limite_minimo, fornecedor_nome, fornecedor_telefone, fornecedor_endereco, notas, ultima_atualizacao, quantidade)
                    VALUES (?, ?, ?, ?, ?, ?, ?, ?, 0)
                `;
                params = [nome, categoria, limite_minimo, fornecedor_nome, fornecedor_telefone, fornecedor_endereco, notas, dataAtual];
                message = 'Novo item salvo com sucesso!';
            }

            await window.api.run(sql, params);
            
            this.showMessage(message, 'success');
            this.fecharModalEstoque();
            this.loadEstoque(); // Recarrega a lista

        } catch (err) {
            console.error('Erro ao salvar item:', err.message);
            this.showMessage(`Erro ao salvar item: ${err.message}`, 'error');
        }
    }
    
    async editarItemEstoque(id) {
        try {
            const item = await window.api.all('SELECT * FROM estoque WHERE id = ?', [id]);
            if (item && item.length > 0) {
                const dados = item[0];
                document.getElementById('item-id').value = dados.id;
                document.getElementById('item-nome').value = dados.nome;
                document.getElementById('item-categoria').value = dados.categoria;
                document.getElementById('item-limite-minimo').value = dados.limite_minimo;
                document.getElementById('item-fornecedor-nome').value = dados.fornecedor_nome;
                document.getElementById('item-fornecedor-telefone').value = dados.fornecedor_telefone;
                document.getElementById('item-fornecedor-endereco').value = dados.fornecedor_endereco;
                document.getElementById('item-notas').value = dados.notas;
                
                document.getElementById('titulo-modal-item-estoque').textContent = 'Editar Item do Estoque';
                document.getElementById('modal-item-estoque').style.display = 'flex';
            }
        } catch (err) {
            console.error('Erro ao buscar item para edição:', err.message);
        }
    }
    
    abrirModalAtualizarEstoque(id, nome, qtdAtual) {
        document.getElementById('form-atualizar-estoque').reset();
        document.getElementById('atualizar-item-id').value = id;
        document.getElementById('atualizar-item-nome').textContent = nome;
        document.getElementById('atualizar-item-qtd').textContent = qtdAtual;
        // Garante que o campo de valor esteja visível (pois "Entrada" é o padrão)
        document.getElementById('campo-valor-lote').style.display = 'block';
        document.getElementById('modal-atualizar-estoque').style.display = 'flex';
    }

    fecharModalAtualizarEstoque() {
        document.getElementById('modal-atualizar-estoque').style.display = 'none';
    }

    async atualizarQuantidadeEstoque() {
        const id = document.getElementById('atualizar-item-id').value;
        const tipo = document.getElementById('atualizar-tipo').value;
        const quantidade = parseInt(document.getElementById('atualizar-quantidade').value, 10);
        const valorLote = document.getElementById('item-valor-lote').value;
        const notasMov = document.getElementById('atualizar-notas').value; // Usaremos como 'fornecedor_compra'
        const dataAtual = new Date().toISOString().split('T')[0];
        
        if (quantidade <= 0) {
            this.showMessage('A quantidade deve ser positiva.', 'error');
            return;
        }

        try {
            // 1. Pega a quantidade atual
            const item = await window.api.all('SELECT quantidade FROM estoque WHERE id = ?', [id]);
            let qtdAtual = item[0].quantidade;
            
            let novaQtd = 0;
            if (tipo === 'entrada') {
                novaQtd = qtdAtual + quantidade;
                // --- NOVIDADE: Salva na tabela estoque_compras ---
                const sqlCompra = `
                    INSERT INTO estoque_compras (itemId, data_compra, quantidade_comprada, valor_lote, fornecedor_compra)
                    VALUES (?, ?, ?, ?, ?)
                `;
                // Se o valor não for preenchido, salva como NULL
                const valorLoteFinal = valorLote ? parseFloat(valorLote) : null;
                await window.api.run(sqlCompra, [id, dataAtual, quantidade, valorLoteFinal, notasMov]);
                // --- FIM DA NOVIDADE ---

            } else { // tipo === 'saida'
                novaQtd = qtdAtual - quantidade;
                if (novaQtd < 0) {
                    this.showMessage('Erro: Não é possível dar saída, estoque ficaria negativo.', 'error');
                    return;
                }
            }
            // 2. Atualiza a quantidade total no banco
            const sql = 'UPDATE estoque SET quantidade = ?, ultima_atualizacao = ? WHERE id = ?';
            await window.api.run(sql, [novaQtd, dataAtual, id]);
            
            this.showMessage('Estoque atualizado com sucesso!', 'success');
            this.fecharModalAtualizarEstoque();
            this.loadEstoque(); 
            this.updateDashboard(); 
            
        } catch (err) {
            console.error('Erro ao atualizar quantidade:', err.message);
            this.showMessage('Erro ao atualizar quantidade.', 'error');
        }
    }

    async excluirItemEstoque(id) {
        // Reutiliza o nosso modal de confirmação universal
        this.abrirModalConfirmacao(
            'Tem certeza que deseja excluir este item do estoque?\n\nTODO O HISTÓRICO DE COMPRAS deste item também será apagado. Esta ação não pode ser desfeita.',
            async () => { // O callback
                try {
                    await window.api.run('DELETE FROM estoque WHERE id = ?', [id]);
                    this.showMessage('Item excluído com sucesso.', 'success');
                    this.loadEstoque();
                } catch (err) {
                    console.error('Erro ao excluir item:', err.message);
                    this.showMessage('Erro ao excluir item.', 'error');
                }
            }
        );
    }
    // =============================================
    //   FIM: MÉTODOS DO MÓDULO DE ESTOQUE
    // =============================================

    async exportarBackup() {
        const btn = document.getElementById('btn-exportar-backup');
        const statusMsg = document.getElementById('export-status-message');

        // Desativa o botão e mostra "carregando"
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Gerando backup...';
        statusMsg.textContent = 'Isso pode levar alguns segundos...';
        statusMsg.style.color = '#ffc107';

        try {
            // 1. Chama a função do preload/main.js
            const resultado = await window.api.exportarBackup();

            if (resultado.success) {
                // 2. Sucesso!
                statusMsg.textContent = resultado.message;
                statusMsg.style.color = 'green';
                this.showMessage('Backup gerado com sucesso!', 'success');
            } else {
                // 3. Erro (ou cancelado pelo usuário)
                statusMsg.textContent = `Falha: ${resultado.message}`;
                statusMsg.style.color = 'red';
                if (!resultado.message.includes('cancelada')) {
                     this.showMessage(resultado.message, 'error');
                }
            }

        } catch (err) {
            console.error('Erro fatal ao exportar backup:', err.message);
            statusMsg.textContent = 'Erro fatal: ' + err.message;
            statusMsg.style.color = 'red';
            this.showMessage('Erro fatal: ' + err.message, 'error');
        }

        // 4. Reativa o botão
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-file-export"></i> Exportar Backup Completo';
    }

    fecharModalHistorico() {
        document.getElementById('modal-historico-compras').style.display = 'none';
    }

    async abrirModalHistorico(itemId) {
        const tbody = document.getElementById('historico-tbody');
        tbody.innerHTML = ''; // Limpa a tabela
        
        try {
            // Pega o nome do item
            const itemInfo = await window.api.all('SELECT nome FROM estoque WHERE id = ?', [itemId]);
            document.getElementById('historico-item-nome').textContent = itemInfo[0].nome;
            
            // Busca o histórico
            const sql = 'SELECT * FROM estoque_compras WHERE itemId = ? ORDER BY data_compra DESC';
            const compras = await window.api.all(sql, [itemId]);
            
            const formatBRL = (val) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(val);

            if (compras && compras.length > 0) {
                compras.forEach(c => {
                    const row = tbody.insertRow();
                    const dataFormatada = c.data_compra.split('-').reverse().join('/');
                    const valorFormatado = c.valor_lote ? formatBRL(c.valor_lote) : '---';
                    
                    row.innerHTML = `
                        <td>${dataFormatada}</td>
                        <td>${c.quantidade_comprada}</td>
                        <td>${valorFormatado}</td>
                        <td>${c.fornecedor_compra || '---'}</td>
                    `;
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #ccc;">Nenhum histórico de compra encontrado.</td></tr>';
            }
            
            document.getElementById('modal-historico-compras').style.display = 'flex';
        } catch (err) {
            console.error('Erro ao buscar histórico de compras:', err.message);
        }
    }

    async imprimirContrato(tratamentoId) {
        console.log(`Iniciando impressão para tratamento ID: ${tratamentoId}`);
        
        // CORREÇÃO AQUI
        const sql = `
            SELECT 
                t.data, /* <-- ADICIONE ESTA LINHA */
                t.descricao, 
                t.valor_total,
                p.nome AS pacienteNome,
                p.cpf AS pacienteCpf
            FROM tratamentos t
            JOIN pacientes p ON t.pacienteId = p.id
            WHERE t.id = ?
        `;

        try {
            const resultados = await window.api.all(sql, [tratamentoId]);
            
            if (resultados && resultados.length > 0) {
                const dadosContrato = resultados[0];
                
                // Agora 'dadosContrato' também contém o campo 'data'
                const resultadoImpressao = await window.api.printContrato(dadosContrato);
                
                if (resultadoImpressao.success) {
                    console.log('Impressão confirmada pelo main process.');
                }
            } else {
                console.error('Nenhum dado encontrado para este tratamento.');
            }
        } catch (err) {
            console.error('Erro ao gerar impressão:', err.message);
        }
    }

    /**
     * Busca dados e chama o main process para imprimir a ANAMNESE
     */
    async imprimirAnamnese() {
        // Pega o ID do paciente do formulário de anamnese
        // (Vou supor que você tem um input 'anamnese-paciente-id' no seu modal)
        const pacienteId = document.getElementById('anamnese-paciente-id').value; 
        
        if (!pacienteId) {
            console.error('ID do Paciente não encontrado no modal de anamnese.');
            // (Adicione um alerta para o usuário se quiser)
            return;
        }

        console.log(`Iniciando impressão da anamnese para Paciente ID: ${pacienteId}`);
        
        // SQL para buscar TUDO do paciente e da anamnese
        const sql = `
            SELECT * FROM pacientes p
            LEFT JOIN anamnese a ON p.id = a.pacienteId
            WHERE p.id = ?
        `;

        try {
            const resultados = await window.api.all(sql, [pacienteId]);
            
            if (resultados && resultados.length > 0) {
                const dados = resultados[0];
                
                // Envia o objeto 'dados' inteiro para o main.js (via preload)
                const resultadoImpressao = await window.api.printAnamnese(dados);
                
                if (resultadoImpressao.success) {
                    console.log('Impressão da anamnese confirmada pelo main process.');
                }
            } else {
                console.error('Nenhum dado de paciente/anamnese encontrado.');
            }
        } catch (err) {
            console.error('Erro ao gerar impressão da anamnese:', err.message);
        }
    }

    // --- INÍCIO: MÉTODOS DE PAGAMENTO ---

    /**
     * Salva um novo pagamento no banco de dados
     */
    async salvarPagamento() {
        const tratamentoId = document.getElementById('pagamento-tratamento-id').value;
        const data = document.getElementById('pagamento-data').value;
        const valorPago = document.getElementById('pagamento-valor').value;
        const formaPagamento = document.getElementById('pagamento-forma').value;

        // --- DEBUG LOGS ---
        console.log('--- Tentando Salvar Pagamento ---');
        console.log('ID do Tratamento:', tratamentoId);
        console.log('Data:', data);
        console.log('Valor Pago:', valorPago);
        console.log('Forma de Pagamento:', formaPagamento);
        // --- FIM DEBUG LOGS ---

        // Validação
        //if (!tratamentoId || !data || !valorPago || !formaPagamento) {
           // console.error('ERRO DE VALIDAÇÃO: Um dos campos acima está vazio.');
           // return;
        //}

        const sqlPagamento = `
            INSERT INTO pagamentos (tratamentoId, data, valor_pago, forma_pagamento)
            VALUES (?, ?, ?, ?)
        `;

        try {
            await window.api.run(sqlPagamento, [tratamentoId, data, valorPago, formaPagamento]);

            // (O resto da lógica para atualizar o status...)
            const sumResult = await window.api.all(
                'SELECT SUM(valor_pago) AS totalPago FROM pagamentos WHERE tratamentoId = ?', 
                [tratamentoId]
            );
            const totalPago = sumResult[0].totalPago || 0;

            const tratResult = await window.api.all(
                'SELECT valor_total FROM tratamentos WHERE id = ?',
                [tratamentoId]
            );
            const valorTotal = tratResult[0].valor_total;
            
            const newStatus = (totalPago >= valorTotal) ? 'pago' : 'parcelado';

            await window.api.run(
                'UPDATE tratamentos SET status_pagamento = ? WHERE id = ?',
                [newStatus, tratamentoId]
            );

            console.log('Pagamento salvo com sucesso!');
            this.fecharModalPagamento();
            this.carregarTratamentos();
            this.carregarPagamentosRecentes();

        } catch (err) {
            console.error('Erro ao salvar pagamento no banco:', err.message);
        }
    }

    async carregarPagamentosRecentes() {
        const tbody = document.getElementById('tabela-pagamentos-body');
        
        const sql = `
            SELECT 
                p.id, 
                p.data, 
                pac.nome AS pacienteNome,
                p.valor_pago,
                p.forma_pagamento,
                t.descricao AS tratamentoDescricao
            FROM pagamentos p
            JOIN tratamentos t ON p.tratamentoId = t.id
            JOIN pacientes pac ON t.pacienteId = pac.id
            ORDER BY p.data DESC
            LIMIT 10
        `;

        try {
            const pagamentos = await window.api.all(sql, []);
            tbody.innerHTML = '';
            
            if (pagamentos && pagamentos.length > 0) {
                pagamentos.forEach(p => {
                    const row = tbody.insertRow();
                    const dataFormatada = p.data.split('-').reverse().join('/');
                    const valorFormatado = new Intl.NumberFormat('pt-BR', { 
                        style: 'currency', 
                        currency: 'BRL' 
                    }).format(p.valor_pago);
                    
                    row.innerHTML = `
                        <td>${dataFormatada}</td>
                        <td>${p.pacienteNome}</td>
                        <td>${valorFormatado}</td>
                        <td>${p.forma_pagamento}</td>
                        <td>${p.tratamentoDescricao}</td>
                        <td>
                            <button class="btn-sm btn-danger" title="Excluir Pagamento" onclick="sistema.excluirPagamento(${p.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: grey;">Nenhum pagamento recente</td></tr>';
            }
        } catch (err) {
            console.error('Erro ao carregar pagamentos:', err.message);
            tbody.innerHTML = '<tr style="text-align: center; color: red;"><td colspan="6">Erro ao carregar pagamentos</td></tr>';
        }
    }

    async excluirPagamento(id) {
        // Esta é a lógica de exclusão que queremos executar
        const exclusaoCallback = async () => {
            try {
                const pag = await window.api.all('SELECT tratamentoId FROM pagamentos WHERE id = ?', [id]);
                const tratamentoId = pag[0]?.tratamentoId;

                await window.api.run('DELETE FROM pagamentos WHERE id = ?', [id]);
                console.log('Pagamento excluído.');

                if (tratamentoId) {
                    const sumResult = await window.api.all(
                        'SELECT SUM(valor_pago) AS totalPago FROM pagamentos WHERE tratamentoId = ?', 
                        [tratamentoId]
                    );
                    const totalPago = sumResult[0].totalPago || 0;

                    const tratResult = await window.api.all(
                        'SELECT valor_total FROM tratamentos WHERE id = ?',
                        [tratamentoId]
                    );
                    const valorTotal = tratResult[0].valor_total;

                    let newStatus = 'pendente'; 
                    if (totalPago > 0) {
                        newStatus = (totalPago >= valorTotal) ? 'pago' : 'parcelado';
                    }

                    await window.api.run(
                        'UPDATE tratamentos SET status_pagamento = ? WHERE id = ?',
                        [newStatus, tratamentoId]
                    );
                }

                this.carregarPagamentosRecentes();
                this.carregarTratamentos();
                
            } catch (err) {
                console.error('Erro ao excluir pagamento:', err.message);
            }
        };

        this.abrirModalConfirmacao(
            'Tem certeza que deseja excluir este pagamento?\n\nEsta ação não pode ser desfeita.',
            exclusaoCallback // Passa a função
        );
    }

    async abrirModalConsulta() {
        try {
            // 1. Limpa o formulário e o ID
            document.getElementById('form-consulta').reset();
            document.getElementById('consulta-id').value = '';
            document.getElementById('titulo-modal-consulta').textContent = 'Agendar Nova Consulta';

            const selectPacientes = document.getElementById('consulta-paciente');
            selectPacientes.innerHTML = '<option value="">Selecione um paciente...</option>'; // Limpa opções antigas

            const pacientes = await window.api.all('SELECT id, nome FROM pacientes ORDER BY nome ASC', []);
            
            if (pacientes) {
                pacientes.forEach(paciente => {
                    const option = new Option(paciente.nome, paciente.id); 
                    selectPacientes.add(option);
                });
            }

            const today = new Date().toISOString().split('T')[0];
            document.getElementById('consulta-data').value = today;

            document.getElementById('modal-consulta').style.display = 'flex';

        } catch (err) {
            console.error('Erro ao abrir modal de consulta:', err.message);

        }
    }

    fecharModalConsulta() {
        document.getElementById('modal-consulta').style.display = 'none';
    }

    // ===============================================
    // GERENCIAMENTO DE CONSULTAS (Tudo Async)
    // ===============================================
    async saveConsulta() {
            const id = document.getElementById('consulta-id').value;
            const consulta = {
                pacienteId: document.getElementById('consulta-paciente').value,
                data: document.getElementById('consulta-data').value,
                hora: document.getElementById('consulta-hora').value,
                tipo: document.getElementById('consulta-tipo').value,
                status: document.getElementById('consulta-status').value,
                duracao: document.getElementById('consulta-duracao').value,
                observacoes: document.getElementById('consulta-observacoes').value,
            };

            if (!consulta.pacienteId || !consulta.data || !consulta.hora) {
                this.showMessage('Por favor, preencha Paciente, Data e Hora.', 'error');
                return;
            }

            let message = ''; // Variável para a mensagem

            try {
                if (id) {
                    // UPDATE (Editar)
                    const sql = `
                        UPDATE consultas SET 
                        pacienteId = ?, data = ?, hora = ?, tipo = ?, 
                        status = ?, duracao = ?, observacoes = ?
                        WHERE id = ?
                    `;
                    const params = [
                        consulta.pacienteId, consulta.data, consulta.hora, consulta.tipo,
                        consulta.status, consulta.duracao, consulta.observacoes, id
                    ];
                    await window.api.run(sql, params);
                    message = 'Consulta atualizada com sucesso!'; // Define a mensagem
                } else {
                    // INSERT (Novo)
                    const sql = `
                        INSERT INTO consultas (id, pacienteId, data, hora, tipo, status, duracao, observacoes)
                        VALUES (?, ?, ?, ?, ?, ?, ?, ?)
                    `;
                    const params = [
                        Date.now().toString(), 
                        consulta.pacienteId, consulta.data, consulta.hora, consulta.tipo,
                        consulta.status, consulta.duracao, consulta.observacoes
                    ];
                    await window.api.run(sql, params);
                    message = 'Consulta salva com sucesso!'; // Define a mensagem
                }

                await this.loadConsultas();
                await this.updateDashboard();
                await this.generateCalendar();
                this.fecharModal('modal-consulta');

                this.showMessage(message);
            } catch (err) {
                console.error('Erro ao salvar consulta:', err);
                this.showMessage('Erro ao salvar consulta.', 'error');
            }
        }

    async loadConsultas() {
        const tbody = document.getElementById('consultas-tbody');
        try {
            // Usamos JOIN para buscar o nome do paciente
            const sql = `
                SELECT c.id, c.data, c.hora, c.tipo, c.status, c.observacoes, p.nome as pacienteNome 
                FROM consultas c
                JOIN pacientes p ON p.id = c.pacienteId
                ORDER BY c.data DESC, c.hora ASC
            `;
            const consultas = await window.api.all(sql);

            if (consultas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #999;">Nenhuma consulta registrada</td></tr>';
                return;
            }

            tbody.innerHTML = consultas.map(consulta => {
                const dataFormatada = new Date(consulta.data).toLocaleDateString('pt-BR', { timeZone: 'UTC' });
                return `
                    <tr>
                        <td>${consulta.pacienteNome}</td>
                        <td>${dataFormatada}</td>
                        <td>${consulta.hora}</td>
                        <td>${this.getTipoConsultaLabel(consulta.tipo)}</td>
                        <td>${this.getStatusLabel(consulta.status)}</td>
                        <td>${consulta.observacoes || '-'}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-small btn-edit" onclick="sistema.editarConsulta('${consulta.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-small btn-delete" onclick="sistema.excluirConsulta('${consulta.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        } catch (err) {
            console.error('Erro ao buscar consultas:', err);
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #f00;">Erro ao carregar consultas</td></tr>';
        }
    }

    async editarConsulta(id) {
        try {
            const resultados = await window.api.all('SELECT * FROM consultas WHERE id = ?', [id]);
            if (!resultados.length) return;
            const consulta = resultados[0];
            
            document.getElementById('consulta-id').value = consulta.id;
            document.getElementById('consulta-paciente').value = consulta.pacienteId;
            document.getElementById('consulta-data').value = consulta.data;
            document.getElementById('consulta-hora').value = consulta.hora;
            document.getElementById('consulta-tipo').value = consulta.tipo;
            document.getElementById('consulta-status').value = consulta.status;
            document.getElementById('consulta-duracao').value = consulta.duracao;
            document.getElementById('consulta-observacoes').value = consulta.observacoes || '';
            
            document.getElementById('titulo-modal-consulta').textContent = 'Editar Consulta';
            this.abrirModal('modal-consulta');
        } catch (err) {
            console.error('Erro ao buscar consulta:', err);
        }
    }

    async excluirConsulta(id) {
        
        const mensagem = 'Tem certeza que deseja excluir esta consulta?\n\nEsta ação não pode ser desfeita.';

        const exclusaoCallback = async () => {
            try {
                // Apaga a consulta
                await window.api.run('DELETE FROM consultas WHERE id = ?', [id]);
                
                console.log('Consulta excluída com sucesso.');
                
                this.loadConsultas(); // Recarrega a lista de consultas
                this.generateCalendar(); // Atualiza o calendário
                this.updateDashboard(); // Atualiza os contadores
                
            } catch (err) {
                console.error('Erro ao excluir consulta:', err.message);
                // this.showMessage('Erro ao excluir consulta: ' + err.message, 'error');
            }
        };

        this.abrirModalConfirmacao(
            mensagem,
            exclusaoCallback 
        );
    }

    // ===============================================
    // DASHBOARD, AGENDA E FUNÇÕES AUXILIARES
    // ===============================================

    async updateDashboard() {
        try {
            // Contar pacientes
            const [pacienteData] = await window.api.all('SELECT COUNT(*) as total FROM pacientes');
            document.getElementById('total-pacientes').textContent = pacienteData.total || 0;

            // Contar consultas hoje
            const today = new Date().toISOString().split('T')[0];
            const [consultasHojeData] = await window.api.all('SELECT COUNT(*) as total FROM consultas WHERE data = ?', [today]);
            document.getElementById('consultas-hoje').textContent = consultasHojeData.total || 0;
            
            // Contar consultas pendentes
            const [consultasPendentesData] = await window.api.all("SELECT COUNT(*) as total FROM consultas WHERE status = 'agendada'");
            document.getElementById('consultas-pendentes').textContent = consultasPendentesData.total || 0;
            
            // Total de consultas
            const [consultasTotalData] = await window.api.all('SELECT COUNT(*) as total FROM consultas');
            document.getElementById('total-consultas').textContent = consultasTotalData.total || 0;
            
            // Carrega a tabela de "Próximas Consultas"
            await this.loadProximasConsultas();

        } catch (err) {
            console.error('Erro ao atualizar dashboard:', err);
        }
    }

    async loadProximasConsultas() {
        const tbody = document.getElementById('proximas-consultas-tbody');
        const hojeStr = new Date().toISOString().split('T')[0]; 
        
        try {
            const sql = `
                SELECT c.data, c.hora, c.tipo, c.status, p.nome as pacienteNome
                FROM consultas c
                JOIN pacientes p ON p.id = c.pacienteId
                WHERE c.data >= ?
                ORDER BY c.data ASC, c.hora ASC
                LIMIT 5
            `;
            const consultas = await window.api.all(sql, [hojeStr]);

            if (consultas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #999;">Nenhuma consulta agendada</td></tr>';
                return;
            }

            tbody.innerHTML = consultas.map(consulta => `
                <tr>
                    <td>${consulta.pacienteNome}</td>
                    <td>${new Date(consulta.data).toLocaleDateString('pt-BR', { timeZone: 'UTC' })}</td>
                    <td>${consulta.hora}</td>
                    <td>${this.getTipoConsultaLabel(consulta.tipo)}</td>
                    <td>${this.getStatusLabel(consulta.status)}</td>
                </tr>
            `).join('');
        } catch (err) {
            console.error('Erro ao carregar próximas consultas:', err);
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #f00;">Erro ao carregar</td></tr>';
        }
    }

    async generateCalendar() {
        const calendarGrid = document.getElementById('calendar-grid');
        const mesAnoEl = document.getElementById('mes-ano');
        calendarGrid.innerHTML = '';
        
        const meses = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
        mesAnoEl.textContent = `${meses[this.currentMonth]} ${this.currentYear}`;
        
        const primeiroDia = new Date(this.currentYear, this.currentMonth, 1).getDay();
        const diasNoMes = new Date(this.currentYear, this.currentMonth + 1, 0).getDate();
        
        // Busca todas as consultas do mês de uma vez
        const inicioMes = `${this.currentYear}-${String(this.currentMonth + 1).padStart(2, '0')}-01`;
        const fimMes = `${this.currentYear}-${String(this.currentMonth + 1).padStart(2, '0')}-${String(diasNoMes).padStart(2, '0')}`;
        
        const sql = `SELECT data, COUNT(*) as total FROM consultas WHERE data BETWEEN ? AND ? GROUP BY data`;
        const consultasDoMes = await window.api.all(sql, [inicioMes, fimMes]);
        
        // Mapeia para busca rápida
        const consultasMap = new Map();
        consultasDoMes.forEach(c => {
            consultasMap.set(c.data, c.total);
        });
        
        const hojeISO = new Date().toISOString().split('T')[0];

        // Cria os dias em branco
        for (let i = 0; i < primeiroDia; i++) {
            calendarGrid.innerHTML += `<div class="calendar-day empty"></div>`;
        }
        
        // Cria os dias do mês
        for (let dia = 1; dia <= diasNoMes; dia++) {
            const dataISO = `${this.currentYear}-${String(this.currentMonth + 1).padStart(2, '0')}-${String(dia).padStart(2, '0')}`;
            
            const dayEl = document.createElement('div');
            dayEl.classList.add('calendar-day');
            dayEl.textContent = dia;

            if (dataISO === hojeISO) {
                dayEl.classList.add('today');
            }
            
            if (consultasMap.has(dataISO)) {
                dayEl.classList.add('has-appointment');
                const dot = document.createElement('div');
                dot.className = 'appointment-dot';
                dayEl.appendChild(dot);
                
                dayEl.onclick = () => {
                    sistema.abrirModalAgendaDia(dataISO);
                };
            }
            
            calendarGrid.appendChild(dayEl);
        }
    }

    async mostrarConsultasDoDia(data) {
        const dataFormatada = new Date(data).toLocaleDateString('pt-BR', { timeZone: 'UTC' });
        let consultas;
        try {
            const sql = `
                SELECT c.hora, c.tipo, p.nome as pacienteNome
                FROM consultas c
                JOIN pacientes p ON p.id = c.pacienteId
                WHERE c.data = ? ORDER BY c.hora ASC
            `;
            consultas = await window.api.all(sql, [data]);
        } catch (err) {
            console.error('Erro ao buscar consultas do dia:', err);
            return alert(`Erro ao buscar consultas para ${dataFormatada}`);
        }

        if (consultas.length === 0) {
            return alert(`Nenhuma consulta agendada para ${dataFormatada}`);
        }
        
        const pacientesConsultas = consultas.map(c => 
            `${c.hora} - ${c.pacienteNome} (${this.getTipoConsultaLabel(c.tipo)})`
        ).join('\n');
        
        alert(`Consultas do dia ${dataFormatada}:\n\n${pacientesConsultas}`);
    }

    mesAnterior() {
        this.currentMonth--;
        if (this.currentMonth < 0) { this.currentMonth = 11; this.currentYear--; }
        this.generateCalendar();
    }

    mesPosterior() {
        this.currentMonth++;
        if (this.currentMonth > 11) { this.currentMonth = 0; this.currentYear++; }
        this.generateCalendar();
    }

    async updatePacientesSelect() {
        const select = document.getElementById('consulta-paciente');
        if (!select) return; 
        try {
            const pacientes = await window.api.all('SELECT id, nome FROM pacientes ORDER BY nome');
            const placeholder = select.querySelector('option[value=""]');
            select.innerHTML = ''; 
            if (placeholder) select.appendChild(placeholder);
            pacientes.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = p.nome;
                select.appendChild(option);
            });
        } catch (err) {
            console.error('Erro ao carregar pacientes para o select:', err);
        }
    }

    fecharModalViewItem() {
        document.getElementById('modal-item-view').style.display = 'none';
    }

    async abrirModalViewItem(itemId) {
        // Função helper para evitar "null"
        const get = (key) => (key || '---'); 
        const formatBRL = (val) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(val);

        try {
            // 1. Buscar os dados principais do item
            const itemSql = 'SELECT * FROM estoque WHERE id = ?';
            const itemResult = await window.api.all(itemSql, [itemId]);
            if (!itemResult || itemResult.length === 0) {
                this.showMessage('Erro: Item não encontrado.', 'error');
                return;
            }
            const item = itemResult[0];

            // 2. Preencher os dados
            document.getElementById('view-item-nome').textContent = `Prontuário de: ${get(item.nome)}`;
            document.getElementById('view-item-nome-completo').textContent = get(item.nome);
            document.getElementById('view-item-categoria').textContent = get(item.categoria);
            document.getElementById('view-item-quantidade').textContent = get(item.quantidade);
            document.getElementById('view-item-limite').textContent = get(item.limite_minimo);
            
            document.getElementById('view-fornecedor-nome').textContent = get(item.fornecedor_nome);
            document.getElementById('view-fornecedor-telefone').textContent = get(item.fornecedor_telefone);
            document.getElementById('view-fornecedor-endereco').textContent = get(item.fornecedor_endereco);
            
            document.getElementById('view-item-notas').textContent = get(item.notas);

            // 3. Buscar e preencher o Histórico de Compras
            const tbody = document.getElementById('view-historico-tbody');
            tbody.innerHTML = ''; // Limpa a tabela
            
            const sqlCompras = 'SELECT * FROM estoque_compras WHERE itemId = ? ORDER BY data_compra DESC LIMIT 10';
            const compras = await window.api.all(sqlCompras, [itemId]);

            if (compras && compras.length > 0) {
                compras.forEach(c => {
                    const row = tbody.insertRow();
                    const dataFormatada = c.data_compra.split('-').reverse().join('/');
                    const valorFormatado = c.valor_lote ? formatBRL(c.valor_lote) : '---';
                    
                    row.innerHTML = `
                        <td>${dataFormatada}</td>
                        <td>${c.quantidade_comprada}</td>
                        <td>${valorFormatado}</td>
                    `;
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: #ccc;">Nenhum histórico de compra.</td></tr>';
            }

            // 4. Abrir o modal
            document.getElementById('modal-item-view').style.display = 'flex';

        } catch (err) {
            console.error('Erro ao abrir prontuário do item:', err.message);
            this.showMessage('Erro ao carregar dados do item.', 'error');
        }
    }

    // --- INÍCIO: MÉTODOS DE RELATÓRIO (VERSÃO COMPLETA) ---
    async gerarRelatorio() {
        const periodo = document.getElementById('report-periodo').value;
        const tipoRelatorio = document.getElementById('report-tipo').value;
        const resultsArea = document.getElementById('report-results-area');

        const { inicio, fim, nomePeriodo } = this.getDatesFromPeriod(periodo);

        resultsArea.innerHTML = `<h5>Gerando relatório...</h5>`;

        try {
            // Usa um 'switch' para chamar a função correta
            switch (tipoRelatorio) {
                case 'financeiro':
                    await this.gerarRelatorioFinanceiro(inicio, fim, nomePeriodo, resultsArea);
                    break;
                case 'pacientes':
                    await this.gerarRelatorioPacientes(inicio, fim, nomePeriodo, resultsArea);
                    break;
                case 'consultas':
                    await this.gerarRelatorioConsultas(inicio, fim, nomePeriodo, resultsArea);
                    break;
                default:
                    resultsArea.innerHTML = `<h5>Relatório</h5><p>O tipo de relatório '${tipoRelatorio}' ainda não é suportado.</p>`;
            }
        } catch (err) {
            console.error('Erro ao gerar relatório:', err.message);
            resultsArea.innerHTML = `<h5>Erro</h5><p>Não foi possível gerar o relatório. Erro: ${err.message}</p>`;
        }
    }

    async gerarRelatorioFinanceiro(inicio, fim, nomePeriodo, resultsArea) {
        // Consulta 1: Total de TRATAMENTOS criados no período
        const sqlTratamentos = `
            SELECT SUM(valor_total) as total_contratado 
            FROM tratamentos 
            WHERE data BETWEEN ? AND ?
        `;
        const resTratamentos = await window.api.all(sqlTratamentos, [inicio, fim]);
        const totalContratado = resTratamentos[0]?.total_contratado || 0;

        // Consulta 2: Total de PAGAMENTOS recebidos no período, agrupados por forma
        const sqlPagamentos = `
            SELECT SUM(valor_pago) as total_recebido, forma_pagamento 
            FROM pagamentos 
            WHERE data BETWEEN ? AND ? 
            GROUP BY forma_pagamento
        `;
        const resPagamentos = await window.api.all(sqlPagamentos, [inicio, fim]);
        
        const totalRecebido = resPagamentos.reduce((acc, p) => acc + p.total_recebido, 0);
        const formatBRL = (val) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(val);

        let htmlResultado = `
            <h5>Relatório Financeiro - ${nomePeriodo}</h5>
            <p>Período de ${inicio.split('-').reverse().join('/')} até ${fim.split('-').reverse().join('/')}</p>
            
            <h6 style="margin-top: 20px;">Recebimentos (Pagamentos Recebidos)</h6>
            <h4 style="color: green; margin-bottom: 15px;">Total Recebido: ${formatBRL(totalRecebido)}</h4>
        `;

        if (resPagamentos.length > 0) {
            htmlResultado += '<ul>';
            resPagamentos.forEach(p => {
                htmlResultado += `<li><strong>${p.forma_pagamento}:</strong> ${formatBRL(p.total_recebido)}</li>`;
            });
            htmlResultado += '</ul>';
        } else {
            htmlResultado += '<p>Nenhum pagamento recebido neste período.</p>';
        }

        htmlResultado += `
            <h6 style="margin-top: 20px;">Produção (Tratamentos Iniciados)</h6>
            <h4 style="margin-bottom: 15px;">Total Contratado: ${formatBRL(totalContratado)}</h4>
            <p>${totalContratado > 0 ? 'Total em novos tratamentos iniciados no período.' : 'Nenhum novo tratamento iniciado no período.'}</p>
        `;

        resultsArea.innerHTML = htmlResultado;
    }

    async gerarRelatorioPacientes(inicio, fim, nomePeriodo, resultsArea) {
        // (O seu código antigo não tinha dataCadastro, então vamos checar se a coluna existe)
        let novosPacientes = 0;
        try {
            // Tenta buscar por data de cadastro (se a coluna existir)
            const sqlNovos = `SELECT COUNT(*) as novos FROM pacientes WHERE dataCadastro BETWEEN ? AND ?`;
            const resNovos = await window.api.all(sqlNovos, [inicio, fim]);
            novosPacientes = resNovos[0]?.novos || 0;
        } catch(e) {
            console.warn("Coluna 'dataCadastro' não encontrada, mostrando apenas total.");
        }

        const sqlTotal = `SELECT COUNT(*) as total FROM pacientes`;
        const resTotal = await window.api.all(sqlTotal, []);
        const totalPacientes = resTotal[0]?.total || 0;

        let htmlResultado = `
            <h5>Relatório de Pacientes - ${nomePeriodo}</h5>
            <p>Período de ${inicio.split('-').reverse().join('/')} até ${fim.split('-').reverse().join('/')}</p>
            
            <h6 style="margin-top: 20px;">Total de Pacientes</h6>
            <h4 style="margin-bottom: 15px;">${totalPacientes} pacientes cadastrados</h4>
            
            <h6 style="margin-top: 20px;">Novos Pacientes</h6>
            <h4 style="margin-bottom: 15px;">${novosPacientes} pacientes cadastrados no período</h4>
        `;
        resultsArea.innerHTML = htmlResultado;
    }

    async gerarRelatorioConsultas(inicio, fim, nomePeriodo, resultsArea) {
        // A consulta SQL está correta
        const sqlStatus = `
            SELECT status, COUNT(*) as total 
            FROM consultas 
            WHERE data BETWEEN ? AND ? 
            GROUP BY status
        `;
        const resStatus = await window.api.all(sqlStatus, [inicio, fim]);

        let stats = {
            realizada: 0,
            pendente: 0,
            cancelada: 0
        };
        
        let totalConsultas = 0;
        // Agora usamos os status em minúsculo para bater com o banco de dados
        resStatus.forEach(r => {
            totalConsultas += r.total;
            
            switch (r.status) {
                case 'agendada':
                case 'confirmada':
                    stats.pendente += r.total;
                    break;
                
                // (Assumindo que o status 'realizada' também será em minúsculo)
                case 'realizada':
                    stats.realizada += r.total;
                    break;
                case 'cancelada':
                    stats.cancelada += r.total;
                    break;
            }
        });

        // O HTML de resultado não muda
        let htmlResultado = `
            <h5>Relatório de Consultas - ${nomePeriodo}</h5>
            <p>Período de ${inicio.split('-').reverse().join('/')} até ${fim.split('-').reverse().join('/')}</p>
            
            <h6 style="margin-top: 20px;">Total de Consultas no Período</h6>
            <h4 style="margin-bottom: 15px;">${totalConsultas} consultas</h4>
            
            <ul style="list-style-type: none; padding-left: 0;">
                <li style="color: green;"><strong>Realizadas:</strong> ${stats.realizada}</li>
                <li style="color: orange;"><strong>Pendentes:</strong> ${stats.pendente}</li>
                <li style="color: red;"><strong>Canceladas:</strong> ${stats.cancelada}</li>
            </ul>
        `;
        resultsArea.innerHTML = htmlResultado;
    }

    getDatesFromPeriod(periodo) {
        const hoje = new Date();
        const hojeFim = new Date();
        hoje.setHours(0, 0, 0, 0); // Início do dia
        hojeFim.setHours(23, 59, 59, 999); // Fim do dia

        let inicio = new Date(hoje);
        let fim = new Date(hojeFim);
        let nomePeriodo = "Hoje";

        switch (periodo) {
            case 'hoje':
                break;
            case 'semana':
                const diaSemana = hoje.getDay(); // 0 (Dom) - 6 (Sáb)
                inicio.setDate(hoje.getDate() - diaSemana);
                fim.setDate(hoje.getDate() + (6 - diaSemana));
                fim.setHours(23, 59, 59, 999);
                nomePeriodo = "Esta Semana";
                break;
            case 'mes':
                inicio = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
                fim = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0);
                fim.setHours(23, 59, 59, 999);
                nomePeriodo = "Este Mês";
                break;
            case 'mes_passado':
                inicio = new Date(hoje.getFullYear(), hoje.getMonth() - 1, 1);
                fim = new Date(hoje.getFullYear(), hoje.getMonth(), 0);
                fim.setHours(23, 59, 59, 999);
                nomePeriodo = "Mês Passado";
                break;
        }

        const formatSQL = (date) => date.toISOString().split('T')[0];

        return { inicio: formatSQL(inicio), fim: formatSQL(fim), nomePeriodo };
    }

    // --- FIM: MÉTODOS DE RELATÓRIO ---

    async abrirModalAnamnese(pacienteId) {
            // 1. Limpa o formulário antes de preencher
            document.getElementById('form-anamnese').reset();
            document.getElementById('anamnese-paciente-id').value = pacienteId;

            try {
                // 2. Busca os dados do PACIENTE (para os campos de cima)
                const [paciente] = await window.api.all('SELECT * FROM pacientes WHERE id = ?', [pacienteId]);
                if (paciente) {
                    document.getElementById('anamnese-nome').value = paciente.nome || '';
                    document.getElementById('anamnese-cpf').value = paciente.cpf || '';
                    document.getElementById('anamnese-nascimento').value = paciente.nascimento ? new Date(paciente.nascimento).toLocaleDateString('pt-BR', { timeZone: 'UTC' }) : '';
                    document.getElementById('anamnese-fone').value = paciente.telefone || '';
                    document.getElementById('anamnese-email').value = paciente.email || '';
                    // Preenche campos que podem ser editados (se estiverem vazios)
                    document.getElementById('anamnese-endereco').value = paciente.endereco || '';
                }

                // 3. Busca a ANAMNESE (se já existir)
                const [anamnese] = await window.api.all('SELECT * FROM anamnese WHERE pacienteId = ?', [pacienteId]);
                
                if (anamnese) {
                    // Preenche os dados de contato (se existirem na anamnese)
                    document.getElementById('anamnese-endereco').value = anamnese.endereco || paciente.endereco; // Prioriza o da anamnese
                    document.getElementById('anamnese-cep').value = anamnese.cep || '';
                    document.getElementById('anamnese-fone-emergencia').value = anamnese.fone_emergencia || '';
                    document.getElementById('anamnese-falar-com').value = anamnese.falar_com || '';
                    document.getElementById('anamnese-email').value = anamnese.email || paciente.email; // Prioriza o da anamnese

                    // Preenche os checkboxes (1 = true, 0 = false)
                    document.getElementById('anamnese-tratamento-medico').checked = !!anamnese.tratamento_medico;
                    document.getElementById('anamnese-tratamento-medico-qual').value = anamnese.tratamento_medico_qual || '';
                    document.getElementById('anamnese-tomando-medicamento').checked = !!anamnese.tomando_medicamento;
                    document.getElementById('anamnese-tomando-medicamento-qual').value = anamnese.tomando_medicamento_qual || '';
                    document.getElementById('anamnese-alergia-doenca').checked = !!anamnese.alergia_doenca;
                    document.getElementById('anamnese-alergia-doenca-qual').value = anamnese.alergia_doenca_qual || '';
                    document.getElementById('anamnese-diabetico').checked = !!anamnese.diabetico;
                    document.getElementById('anamnese-doenca-coracao').checked = !!anamnese.doenca_coracao;
                    document.getElementById('anamnese-hipertenso').checked = !!anamnese.hipertenso;
                    document.getElementById('anamnese-hemofilico').checked = !!anamnese.hemofilico;
                    document.getElementById('anamnese-pes-incham').checked = !!anamnese.pes_incham;
                    document.getElementById('anamnese-tosse-persistente').checked = !!anamnese.tosse_persistente;
                    document.getElementById('anamnese-alergia-anestesia').checked = !!anamnese.alergia_anestesia;
                    document.getElementById('anamnese-alergia-anestesia-qual').value = anamnese.alergia_anestesia_qual || '';
                    document.getElementById('anamnese-submetido-anestesia').checked = !!anamnese.submetido_anestesia;
                    document.getElementById('anamnese-teve-hemorragia').checked = !!anamnese.teve_hemorragia;
                    document.getElementById('anamnese-tem-vicio').checked = !!anamnese.tem_vicio;
                    document.getElementById('anamnese-tem-vicio-qual').value = anamnese.tem_vicio_qual || '';
                    document.getElementById('anamnese-esta-gravida').checked = !!anamnese.esta_gravida;
                    document.getElementById('anamnese-sofre-epilepsia').checked = !!anamnese.sofre_epilepsia;
                    document.getElementById('anamnese-algo-a-declarar').checked = !!anamnese.algo_a_declarar;
                    document.getElementById('anamnese-algo-a-declarar-qual').value = anamnese.algo_a_declarar_qual || '';
                    
                    document.getElementById('anamnese-odontograma-anotacoes').value = anamnese.odontograma_anotacoes || '';
                }

                // 4. Abre o modal
                this.abrirModal('modal-anamnese');

            } catch (err) {
                console.error('Erro ao abrir anamnese:', err);
                this.showMessage('Erro ao carregar ficha de anamnese.', 'error');
            }
        }

        async saveAnamnese() {
            const pacienteId = document.getElementById('anamnese-paciente-id').value;
            if (!pacienteId) {
                this.showMessage('ID do paciente não encontrado.', 'error');
                return;
            }
            // 1. Coleta todos os dados do formulário
            const dados = {
                pacienteId: pacienteId,
                // Converte os checkboxes para 1 (se marcado) ou 0 (se desmarcado)
                tratamento_medico: document.getElementById('anamnese-tratamento-medico').checked ? 1 : 0,
                tratamento_medico_qual: document.getElementById('anamnese-tratamento-medico-qual').value,
                tomando_medicamento: document.getElementById('anamnese-tomando-medicamento').checked ? 1 : 0,
                tomando_medicamento_qual: document.getElementById('anamnese-tomando-medicamento-qual').value,
                alergia_doenca: document.getElementById('anamnese-alergia-doenca').checked ? 1 : 0,
                alergia_doenca_qual: document.getElementById('anamnese-alergia-doenca-qual').value,
                diabetico: document.getElementById('anamnese-diabetico').checked ? 1 : 0,
                doenca_coracao: document.getElementById('anamnese-doenca-coracao').checked ? 1 : 0,
                hipertenso: document.getElementById('anamnese-hipertenso').checked ? 1 : 0,
                hemofilico: document.getElementById('anamnese-hemofilico').checked ? 1 : 0,
                pes_incham: document.getElementById('anamnese-pes-incham').checked ? 1 : 0,
                tosse_persistente: document.getElementById('anamnese-tosse-persistente').checked ? 1 : 0,
                alergia_anestesia: document.getElementById('anamnese-alergia-anestesia').checked ? 1 : 0,
                alergia_anestesia_qual: document.getElementById('anamnese-alergia-anestesia-qual').value,
                submetido_anestesia: document.getElementById('anamnese-submetido-anestesia').checked ? 1 : 0,
                teve_hemorragia: document.getElementById('anamnese-teve-hemorragia').checked ? 1 : 0,
                tem_vicio: document.getElementById('anamnese-tem-vicio').checked ? 1 : 0,
                tem_vicio_qual: document.getElementById('anamnese-tem-vicio-qual').value,
                esta_gravida: document.getElementById('anamnese-esta-gravida').checked ? 1 : 0,
                sofre_epilepsia: document.getElementById('anamnese-sofre-epilepsia').checked ? 1 : 0,
                algo_a_declarar: document.getElementById('anamnese-algo-a-declarar').checked ? 1 : 0,
                algo_a_declarar_qual: document.getElementById('anamnese-algo-a-declarar-qual').value,
                
                endereco: document.getElementById('anamnese-endereco').value,
                cep: document.getElementById('anamnese-cep').value,
                fone_emergencia: document.getElementById('anamnese-fone-emergencia').value,
                falar_com: document.getElementById('anamnese-falar-com').value,
                email: document.getElementById('anamnese-email').value,

                nome: document.getElementById('anamnese-nome').value,
                cpf: document.getElementById('anamnese-cpf').value,
                data_nascimento: document.getElementById('anamnese-nascimento').value,
                fone: document.getElementById('anamnese-fone').value,
                
                odontograma_anotacoes: document.getElementById('anamnese-odontograma-anotacoes').value,
            };

            const sql = `
                INSERT OR REPLACE INTO anamnese (
                    pacienteId, nome, cpf, data_nascimento, endereco, cep, fone, fone_emergencia, email, falar_com,
                    tratamento_medico, tratamento_medico_qual, tomando_medicamento, tomando_medicamento_qual,
                    alergia_doenca, alergia_doenca_qual, diabetico, doenca_coracao, hipertenso, hemofilico,
                    pes_incham, tosse_persistente, alergia_anestesia, alergia_anestesia_qual,
                    submetido_anestesia, teve_hemorragia, tem_vicio, tem_vicio_qual, esta_gravida,
                    sofre_epilepsia, algo_a_declarar, algo_a_declarar_qual, odontograma_anotacoes
                ) VALUES (
                    ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 
                    ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 
                    ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 
                    ?, ?, ?
                )
            `;

            const params = [
                dados.pacienteId, dados.nome, dados.cpf, dados.data_nascimento, dados.endereco, dados.cep, dados.fone, dados.fone_emergencia, dados.email, dados.falar_com,
                dados.tratamento_medico, dados.tratamento_medico_qual, dados.tomando_medicamento, dados.tomando_medicamento_qual,
                dados.alergia_doenca, dados.alergia_doenca_qual, dados.diabetico, dados.doenca_coracao, dados.hipertenso, dados.hemofilico,
                dados.pes_incham, dados.tosse_persistente, dados.alergia_anestesia, dados.alergia_anestesia_qual,
                dados.submetido_anestesia, dados.teve_hemorragia, dados.tem_vicio, dados.tem_vicio_qual, dados.esta_gravida,
                dados.sofre_epilepsia, dados.algo_a_declarar, dados.algo_a_declarar_qual, dados.odontograma_anotacoes
            ];

            try {
                await window.api.run(sql, params);
                this.fecharModal('modal-anamnese');
                this.showMessage('Ficha de anamnese salva com sucesso!');
            } catch (err) {
                console.error('Erro ao salvar anamnese:', err);
                this.showMessage('Erro ao salvar a ficha.', 'error');
            }
        }

        // --- Funções para o Modal de Zoom ---
            abrirModalZoom(urlDaImagem) {
                // Pega o caminho completo (se já não for um)
                // Isso é um truque para garantir que o Electron encontre a imagem
                const img = new Image();
                img.src = urlDaImagem; 

                document.getElementById('zoom-image-src').src = img.src;
                document.getElementById('modal-imagem-zoom').style.display = 'flex';
            }

            fecharModalZoom() {
                document.getElementById('modal-imagem-zoom').style.display = 'none';
            }

    getTipoConsultaLabel(tipo) {
            const labels = {
                'profilaxia': 'Profilaxia (limpeza)',
                'raspagem_tartaro': 'Raspagem de tártaro',
                'aplicacao_fluor': 'Aplicação de flúor',
                'selantes_dentais': 'Selantes dentais',
                'orientacoes_higiene': 'Orientações de higiene',
                'restauracao_resina': 'Restauração',
                'clareamento_dental': 'Clareamento dental',
                'facetas_lentes': 'Facetas e lentes',
                'ajuste_polimento': 'Ajuste e polimento',
                'tratamento_canal': 'Tratamento de canal',
                'amputacao_radicular': 'Amputação radicular',
                'tratamento_gengiva': 'Tratamento de gengiva',
                'cirurgia_periodontal': 'Cirurgia periodontal',
                'instalacao_aparelho': 'Instalação/Manutenção Aparelho',
                'ajustes_oclusais': 'Ajustes oclusais',
                'extracao_sisos': 'Extração (Siso)',
                'bichectomia': 'Bichectomia',
                'remocao_freio': 'Remoção de freio',
                'alveoloplastia': 'Alveoloplastia',
                'proteses_totais_parciais': 'Prótese total/parcial',
                'implantes_dentarios': 'Implantes dentários',
                'gengivoplastia_estetica': 'Gengivoplastia (estética)',
                'aplicacao_botox': 'Aplicação de botox',
                'tratamento_dente_leite': 'Odontopediatria',
                'atendimento_urgencia': 'Atendimento de urgência',
                'diagnostico_imagem': 'Diagnóstico (Imagem)',
                'testes_risco_carie': 'Testes (Risco de cárie)',
                'consulta': 'Consulta',
                'retorno': 'Retorno',
                'exame': 'Exame',
                'cirurgia': 'Cirurgia',
                'emergencia': 'Emergência'
            };
            return labels[tipo] || tipo;
        }

    getStatusLabel(status) {
        const labels = { 'agendada': 'Agendada', 'confirmada': 'Confirmada', 'em_andamento': 'Em Andamento', 'concluida': 'Concluída', 'cancelada': 'Cancelada' };
        return labels[status] || status;
    }

    abrirModal(modalId) {
        document.getElementById(modalId).style.display = 'block';
    }

    fecharModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
        
        if (modalId === 'modal-paciente') {
            document.getElementById('form-paciente').reset();
            document.getElementById('paciente-id').value = '';
            document.getElementById('titulo-modal-paciente').textContent = 'Cadastrar Novo Paciente';
        } else if (modalId === 'modal-consulta') {
            document.getElementById('form-consulta').reset();
            document.getElementById('consulta-id').value = '';
            document.getElementById('titulo-modal-consulta').textContent = 'Agendar Nova Consulta';
            document.getElementById('consulta-data').value = new Date().toISOString().split('T')[0];
        } else if (modalId === 'modal-anamnese') {
                document.getElementById('form-anamnese').reset();
                document.getElementById('anamnese-paciente-id').value = '';
            }
    }

    showMessage(message, type = 'success') {
        // A 'error' não estava sendo usada, mas é bom ter
        console.log(`Mensagem: ${message} (Tipo: ${type})`);
        //alert(message);
    }
}

        function abrirModalPaciente() {
            sistema.abrirModal('modal-paciente');
        }

        function abrirModalConsulta() {
            sistema.abrirModal('modal-consulta');
        }

        function fecharModal(modalId) {
            sistema.fecharModal(modalId);
        }

        function mesAnterior() {
            sistema.mesAnterior();
        }

        function mesPosterior() {
            sistema.mesPosterior();
        }

        function gerarRelatorio() {
            sistema.gerarRelatorio();
        }
        

        // Initialize system
        const sistema = new SistemaClinica();

        // Close modal when clicking outside
        /* --- DESATIVADO PARA NÃO PERDER DADOS ---
        window.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                e.target.style.display = 'none';
            }
        });
        */

        
    </script>
</body>
</html>